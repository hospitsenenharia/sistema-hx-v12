<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Sistema HX â€” Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background:#0d0d0d; color:#eaeaea; font-family:Arial }
.card { background:#181818; padding:15px; border-radius:10px; margin-bottom:15px }
h2,h3 { color:#0aff9d }
canvas { max-height:240px }
.menu-active { background:#0aff9d; color:black }
.btn { padding:8px 14px; border-radius:8px; border:none; cursor:pointer }
</style>
</head>

<body>

<h2>ðŸ“Š Dashboard Financeiro</h2>

<div class="card">
  <h3>Resumo Geral</h3>
  <div>Faturamento Total: <b id="fatTotal">R$ 0,00</b></div>
  <div>Lucro do MÃªs: <b id="lucroMes">R$ 0,00</b></div>
  <div>Lucro MÃªs Anterior: <b id="lucroMesAnteriorEl">R$ 0,00</b></div>
  <div>VariaÃ§Ã£o: <b id="variacaoLucro">R$ 0,00</b></div>
  <div>Total de Vendas: <b id="numVendas">0</b></div>
  <div>Ordens de ServiÃ§o: <b id="numOS">0</b></div>
</div>

<div class="card">
  <h3>ðŸ“… Filtro</h3>
  <select id="filtroMes">
    <option value="0">Janeiro</option><option value="1">Fevereiro</option>
    <option value="2">MarÃ§o</option><option value="3">Abril</option>
    <option value="4">Maio</option><option value="5">Junho</option>
    <option value="6">Julho</option><option value="7">Agosto</option>
    <option value="8">Setembro</option><option value="9">Outubro</option>
    <option value="10">Novembro</option><option value="11">Dezembro</option>
  </select>
  <input id="filtroAno" type="number" placeholder="Ano">
  <button class="btn" onclick="gerarGraficoLucroMensal()">Aplicar</button>
</div>

<div class="card">
  <h3>ðŸ“ˆ Lucro DiÃ¡rio</h3>
  <canvas id="grafLucroMensal"></canvas>
</div>

<div class="card">
  <h3>ðŸ“Š Vendas DiÃ¡rias</h3>
  <canvas id="grafVendasDiarias"></canvas>
</div>

<script>
// ================= SUPABASE =================
const supabase = supabase.createClient(
  "https://axfccmezfofnqfsdurqb.supabase.co",
  "SUA_CHAVE_ANON_AQUI"
);

// ================= VARIÃVEIS =================
let chartLucroMensal = null;
let chartVendasDiarias = null;

// ================= DASHBOARD =================
async function carregarDashboard() {
  const { data: vendas } = await supabase
    .from("vendas")
    .select("valor, lucro_total, preco_custo, preco_revenda, quantidade, data");

  const { data: os } = await supabase
    .from("ordens_servico")
    .select("id");

  if (!Array.isArray(vendas)) return;

  let faturamento = 0;
  let lucroAtual = 0;
  let lucroAnterior = 0;

  const hoje = new Date();
  const mesAtual = hoje.getMonth();
  const anoAtual = hoje.getFullYear();
  const mesAnterior = mesAtual === 0 ? 11 : mesAtual - 1;
  const anoAnterior = mesAtual === 0 ? anoAtual - 1 : anoAtual;

  vendas.forEach(v => {
    faturamento += Number(v.valor || 0);

    const d = new Date(v.data.split("T")[0] + "T00:00:00");
    const lucro =
      v.lucro_total != null
        ? Number(v.lucro_total)
        : (v.preco_revenda - v.preco_custo) * v.quantidade;

    if (d.getMonth() === mesAtual && d.getFullYear() === anoAtual)
      lucroAtual += lucro;

    if (d.getMonth() === mesAnterior && d.getFullYear() === anoAnterior)
      lucroAnterior += lucro;
  });

  fatTotal.innerText = "R$ " + faturamento.toFixed(2);
  lucroMes.innerText = "R$ " + lucroAtual.toFixed(2);
  lucroMesAnteriorEl.innerText = "R$ " + lucroAnterior.toFixed(2);
  variacaoLucro.innerText = "R$ " + (lucroAtual - lucroAnterior).toFixed(2);
  numVendas.innerText = vendas.length;
  numOS.innerText = os?.length || 0;
}

// ================= GRÃFICO LUCRO =================
async function gerarGraficoLucroMensal() {
  const mes = Number(filtroMes.value);
  const ano = Number(filtroAno.value);
  if (!ano) return;

  const { data: vendas } = await supabase
    .from("vendas")
    .select("data, lucro_total");

  const dados = {};
  vendas.forEach(v => {
    const d = new Date(v.data.split("T")[0] + "T00:00:00");
    if (d.getMonth() !== mes || d.getFullYear() !== ano) return;
    const dia = d.getDate();
    dados[dia] = (dados[dia] || 0) + Number(v.lucro_total || 0);
  });

  if (chartLucroMensal) chartLucroMensal.destroy();
  chartLucroMensal = new Chart(grafLucroMensal, {
    type:"line",
    data:{
      labels:Object.keys(dados).map(d=>"Dia "+d),
      datasets:[{ label:"Lucro", data:Object.values(dados), borderColor:"#0aff9d" }]
    }
  });
}

// ================= GRÃFICO VENDAS =================
async function gerarGraficoVendasDiarias() {
  const { data: vendas } = await supabase
    .from("vendas")
    .select("data, valor");

  const dados = {};
  vendas.forEach(v=>{
    const d = new Date(v.data).toLocaleDateString("pt-BR");
    dados[d]=(dados[d]||0)+Number(v.valor||0);
  });

  if (chartVendasDiarias) chartVendasDiarias.destroy();
  chartVendasDiarias = new Chart(grafVendasDiarias,{
    type:"bar",
    data:{ labels:Object.keys(dados), datasets:[{data:Object.values(dados)}] }
  });
}

// ================= INICIALIZAÃ‡ÃƒO =================
document.addEventListener("DOMContentLoaded", async () => {
  await carregarDashboard();
  await gerarGraficoVendasDiarias();
});
</script>

</body>
</html>
