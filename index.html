<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Sistema HX â€” GestÃ£o Total</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
 --hx-dark:#0d0d0d;--hx-dark2:#151515;--hx-accent:#0aff9d;
 --hx-text:#eaeaea;--hx-danger:#ff5566
}
body{margin:0;background:var(--hx-dark);color:var(--hx-text);
font-family:Segoe UI,sans-serif;display:flex}
#sidebar{width:240px;background:var(--hx-dark2);height:100vh;
position:fixed;border-right:1px solid #333;display:flex;flex-direction:column}
#sidebar button{background:none;border:none;color:#fff;padding:15px;
text-align:left;cursor:pointer;border-left:3px solid transparent}
#sidebar button.active{background:#1f1f1f;color:var(--hx-accent);
border-left-color:var(--hx-accent)}
main{margin-left:240px;flex:1;padding:25px}
.card{background:#181818;padding:20px;border-radius:8px;
margin-bottom:20px;border:1px solid #333}
.grid-dash{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
input,select{width:100%;padding:10px;margin:8px 0;
background:#222;border:1px solid #444;color:#fff;border-radius:4px}
.btn{padding:10px;border:none;border-radius:4px;font-weight:bold;cursor:pointer}
.btn-add{background:var(--hx-accent);color:#000}
.btn-del{background:var(--hx-danger);color:#fff}
</style>
</head>

<body>

<nav id="sidebar">
 <div style="padding:20px;font-weight:bold;color:var(--hx-accent)">PAINEL HX</div>
 <button onclick="tab('dashTab',this)" class="active">ğŸ“Š Dashboard</button>
 <button onclick="tab('cliTab',this)">ğŸ‘¤ Clientes</button>
 <button onclick="tab('estTab',this)">ğŸ“¦ Estoque</button>
 <button onclick="tab('venTab',this)">ğŸ’µ Vendas</button>
</nav>

<main>

<section id="dashTab">
 <div class="grid-dash">
  <div class="card">Vendas Hoje<h3 id="vDia">R$ 0,00</h3></div>
  <div class="card">Lucro Hoje<h3 id="lDia">R$ 0,00</h3></div>
  <div class="card">Vendas MÃªs<h3 id="vMes">R$ 0,00</h3></div>
  <div class="card">Vendas Ano<h3 id="vAno">R$ 0,00</h3></div>
 </div>

 <div class="card">
  <canvas id="chartMes"></canvas>
 </div>

 <button class="btn btn-add" onclick="gerarPDF()">ğŸ“„ RelatÃ³rio Mensal (PDF)</button>
</section>

<section id="cliTab" style="display:none">
 <h2>Clientes</h2>
 <div class="card">
  <input id="cliNome" placeholder="Nome">
  <input id="cliTel" placeholder="Telefone">
  <button class="btn btn-add" onclick="addCliente()">Cadastrar</button>
 </div>
 <div id="listCli"></div>
</section>

<section id="estTab" style="display:none">
 <h2>Estoque</h2>
 <div id="listEst"></div>
</section>

<section id="venTab" style="display:none">
 <h2>PDV</h2>

 <div class="card">
  <select id="vCli"></select>
  <select id="vProd"></select>
  <input id="vQtd" type="number" value="1">
  <button class="btn btn-add" onclick="vender()">Finalizar Venda</button>
 </div>

 <div class="card">
  <input id="fNome" placeholder="Cliente">
  <input id="fData" type="date">
  <button class="btn" onclick="renderVendas()">Filtrar</button>
 </div>

 <div id="listVen"></div>
</section>

</main>

<script>
const { createClient } = supabase;
const db = createClient("SUA_URL_SUPABASE","SUA_CHAVE_PUBLICA");

let cl=[], pr=[], ve=[], chartMes;
let userRole = 'caixa';

/* ================= PERFIL ================= */
async function carregarPerfil(){
 const { data:{user} } = await db.auth.getUser();
 if(!user) return;

 const { data } = await db.from('perfis')
  .select('role').eq('id',user.id).single();

 userRole = data?.role || 'caixa';
}

/* ================= LOAD ================= */
async function load(){
 await carregarPerfil();

 const [{data:c},{data:p},{data:v}] = await Promise.all([
  db.from('clientes').select('*'),
  db.from('produtos').select('*'),
  db.from('vendas').select(`*, clientes(nome), produtos(nome, preco_custo, preco_revenda, quantidade)`)
 ]);

 cl=c||[]; pr=p||[]; ve=v||[];
 renderAll();
}

/* ================= RENDER ================= */
function renderAll(){
 vCli.innerHTML=cl.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
 vProd.innerHTML=pr.map(p=>`<option value="${p.id}">${p.nome}</option>`).join('');

 listCli.innerHTML=cl.map(c=>`<div class="card">${c.nome}</div>`).join('');
 listEst.innerHTML=pr.map(p=>`<div class="card">${p.nome} â€” Estoque: ${p.quantidade||0}</div>`).join('');

 dashboard();
 renderVendas();
}

/* ================= DASHBOARD ================= */
function dashboard(){
 const hojeBR=new Date().toLocaleDateString('pt-BR');
 const mesISO=new Date().toISOString().slice(0,7);
 const ano=new Date().getFullYear();

 let vd=0,ld=0,vm=0,va=0,grp={};

 ve.forEach(v=>{
  const d=new Date(v.data);
  if(d.toLocaleDateString('pt-BR')===hojeBR){vd+=v.valor;ld+=v.lucro_total}
  if(v.data.startsWith(mesISO)){vm+=v.valor;grp[d.getDate()]=(grp[d.getDate()]||0)+v.valor}
  if(d.getFullYear()===ano){va+=v.valor}
 });

 vDia.innerText=`R$ ${vd.toFixed(2)}`;
 lDia.innerText=`R$ ${ld.toFixed(2)}`;
 vMes.innerText=`R$ ${vm.toFixed(2)}`;
 vAno.innerText=`R$ ${va.toFixed(2)}`;

 if(chartMes) chartMes.destroy();
 chartMes=new Chart(chartMes,{
  type:'bar',
  data:{labels:Object.keys(grp),
  datasets:[{label:'Faturamento Mensal',data:Object.values(grp),backgroundColor:'#0aff9d'}]}
 });
}

/* ================= PDF ================= */
function gerarPDF(){
 const { jsPDF } = window.jspdf;
 const pdf=new jsPDF();
 let y=20,total=0;
 const mes=new Date().toISOString().slice(0,7);

 pdf.text(`RELATÃ“RIO ${mes}`,10,10);

 ve.filter(v=>v.data.startsWith(mes)).forEach(v=>{
  pdf.text(`${new Date(v.data).toLocaleDateString()} - ${v.clientes.nome} - R$ ${v.valor}`,10,y);
  y+=8; total+=v.valor;
 });

 pdf.text(`TOTAL: R$ ${total.toFixed(2)}`,10,y+10);
 pdf.save(`relatorio_${mes}.pdf`);
}

/* ================= CRUD ================= */
async function addCliente(){
 await db.from('clientes').insert({nome:cliNome.value,telefone:cliTel.value});
 cliNome.value='';cliTel.value='';
 load();
}

async function vender(){
 const prod=pr.find(p=>p.id==vProd.value);
 const qtd=Number(vQtd.value);
 if(qtd>prod.quantidade) return alert('Estoque insuficiente');

 await db.from('vendas').insert({
  cliente_id:vCli.value, produto_id:prod.id, quantidade:qtd,
  valor:prod.preco_revenda*qtd,
  lucro_total:(prod.preco_revenda-prod.preco_custo)*qtd,
  data:new Date().toISOString()
 });
 load();
}

function renderVendas(){
 listVen.innerHTML=ve.map(v=>`
 <div class="card">
  ${v.clientes.nome} â€” ${v.produtos.nome} â€” R$ ${v.valor}
  ${userRole==='admin'?`<button class="btn-del" onclick="del(${v.id})">ğŸ—‘ï¸</button>`:''}
 </div>`).join('');
}

async function del(id){
 await db.from('vendas').delete().eq('id',id);
 load();
}

function tab(id,b){
 document.querySelectorAll('section').forEach(s=>s.style.display='none');
 document.getElementById(id).style.display='block';
 document.querySelectorAll('#sidebar button').forEach(x=>x.classList.remove('active'));
 b.classList.add('active');
}

load();
</script>
</body>
</html>
