<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Sistema HX â€” AdministraÃ§Ã£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabase = window.supabase.createClient(
  "https://axfccmezfofnqfsdurqb.supabase.co",
  "SUA_ANON_KEY_AQUI"
);
</script>

<style>
:root{
  --accent:#0aff9d;
  --bg:#0d0d0d;
  --card:#181818;
  --text:#eee;
}
body.light{
  --bg:#f5f5f5;
  --card:#fff;
  --text:#111;
}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:var(--text)}
header{padding:15px;background:#151515;color:var(--accent);display:flex;align-items:center}
#sidebar{width:220px;position:fixed;top:0;left:0;height:100vh;background:#151515;padding-top:70px}
#sidebar button{width:100%;padding:12px;border:none;background:none;color:white;text-align:left;cursor:pointer}
.menu-active{background:var(--accent);color:black!important}
main{margin-left:240px;padding:20px}
.card{background:var(--card);padding:15px;border-radius:10px;margin-bottom:15px}
.btn{background:var(--accent);border:none;padding:8px 14px;border-radius:6px;cursor:pointer}
canvas{max-height:220px}
#loginOverlay{position:fixed;inset:0;background:#000c;display:flex;align-items:center;justify-content:center}
.login-box{background:#111;padding:20px;border-radius:10px;width:300px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div class="login-box">
    <h3>Login</h3>
    <input id="loginEmail" placeholder="Email"><br><br>
    <input id="loginPass" type="password" placeholder="Senha"><br><br>
    <button class="btn" onclick="login()">Entrar</button>
    <p id="loginMsg"></p>
  </div>
</div>

<header>
  Sistema HX
  <span id="userLabel" style="margin-left:auto"></span>
  <button class="btn" onclick="toggleTheme()">ðŸŒ™</button>
</header>

<div id="sidebar">
  <button onclick="showSection('dashboardSec',this)" class="menu-active">ðŸ“Š Dashboard</button>
  <button onclick="showSection('vendasSec',this)">ðŸ’° Vendas</button>
  <button onclick="logout()">ðŸšª Sair</button>
</div>

<main>

<!-- DASHBOARD -->
<section id="dashboardSec">
  <h2>Dashboard</h2>

  <div class="card">
    <b>Faturamento Total:</b> <span id="fatTotal">R$ 0,00</span><br>
    <b>Lucro do MÃªs:</b> <span id="lucroMes">R$ 0,00</span><br>
    <b>Total de Vendas:</b> <span id="numVendas">0</span>
  </div>

  <div class="card">
    <select id="filtroMes">
      <option value="0">Janeiro</option><option value="1">Fevereiro</option>
      <option value="2">MarÃ§o</option><option value="3">Abril</option>
      <option value="4">Maio</option><option value="5">Junho</option>
      <option value="6">Julho</option><option value="7">Agosto</option>
      <option value="8">Setembro</option><option value="9">Outubro</option>
      <option value="10">Novembro</option><option value="11">Dezembro</option>
    </select>
    <input id="filtroAno" type="number" placeholder="Ano">
    <button class="btn" onclick="gerarGraficoLucroMensal()">Aplicar</button>
  </div>

  <div class="card">
    <h3>Lucro DiÃ¡rio</h3>
    <canvas id="grafLucroMensal"></canvas>
  </div>

  <div class="card">
    <h3>Vendas DiÃ¡rias</h3>
    <canvas id="grafVendasDiarias"></canvas>
  </div>
</section>

<!-- VENDAS -->
<section id="vendasSec" style="display:none">
  <h2>Registrar Venda</h2>
  <input id="venValor" placeholder="Valor"><br><br>
  <button class="btn" onclick="registrarVenda()">Registrar</button>
</section>

</main>

<script>
let chartLucroMensal=null, chartVendasDiarias=null;

/* ===== LOGIN ===== */
async function login(){
  const {error}=await supabase.auth.signInWithPassword({
    email:loginEmail.value,password:loginPass.value
  });
  if(error){loginMsg.innerText=error.message;return}
  loginOverlay.style.display="none";
  carregarUsuario(); atualizarTudo();
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

async function carregarUsuario(){
  const {data}=await supabase.auth.getUser();
  if(data?.user) userLabel.innerText=data.user.email;
}

/* ===== DASHBOARD ===== */
async function carregarDashboard(){
  const {data:vendas}=await supabase.from("vendas").select("*");
  if(!vendas) return;

  let fat=0,lucro=0;
  const hoje=new Date();

  vendas.forEach(v=>{
    fat+=Number(v.valor||0);
    const d=new Date(v.data);
    if(d.getMonth()===hoje.getMonth()&&d.getFullYear()===hoje.getFullYear())
      lucro+=Number(v.lucro_total||0);
  });

  fatTotal.innerText=`R$ ${fat.toFixed(2)}`;
  lucroMes.innerText=`R$ ${lucro.toFixed(2)}`;
  numVendas.innerText=vendas.length;
}

async function gerarGraficoLucroMensal(){
  const mes=Number(filtroMes.value), ano=Number(filtroAno.value);
  if(!ano)return;

  const {data:vendas}=await supabase.from("vendas").select("data,lucro_total");
  const porDia={};

  vendas.forEach(v=>{
    const d=new Date(v.data);
    if(d.getMonth()!==mes||d.getFullYear()!==ano)return;
    porDia[d.getDate()]=(porDia[d.getDate()]||0)+Number(v.lucro_total||0);
  });

  chartLucroMensal?.destroy();
  chartLucroMensal=new Chart(grafLucroMensal,{
    type:"line",
    data:{labels:Object.keys(porDia),datasets:[{data:Object.values(porDia),borderColor:"#0aff9d"}]}
  });
}

async function gerarGraficoVendasDiarias(){
  const {data:vendas}=await supabase.from("vendas").select("data,valor");
  const porDia={};

  vendas.forEach(v=>{
    const d=new Date(v.data).toLocaleDateString("pt-BR");
    porDia[d]=(porDia[d]||0)+Number(v.valor||0);
  });

  chartVendasDiarias?.destroy();
  chartVendasDiarias=new Chart(grafVendasDiarias,{
    type:"bar",
    data:{labels:Object.keys(porDia),datasets:[{data:Object.values(porDia),backgroundColor:"#0aff9d88"}]}
  });
}

/* ===== VENDAS ===== */
async function registrarVenda(){
  const valor=Number(venValor.value);
  if(valor<=0)return alert("Valor invÃ¡lido");
  await supabase.from("vendas").insert({
    valor, lucro_total:valor*0.3, data:new Date().toISOString()
  });
  venValor.value="";
  atualizarTudo();
}

/* ===== GERAL ===== */
function showSection(id,btn){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll("#sidebar button").forEach(b=>b.classList.remove("menu-active"));
  btn.classList.add("menu-active");
}

function toggleTheme(){
  document.body.classList.toggle("light");
}

async function atualizarTudo(){
  await carregarDashboard();
  await gerarGraficoVendasDiarias();
  gerarGraficoLucroMensal();
}

document.addEventListener("DOMContentLoaded",async()=>{
  const {data}=await supabase.auth.getSession();
  if(!data.session)return;
  loginOverlay.style.display="none";
  carregarUsuario();
  atualizarTudo();
});
</script>

</body>
</html>
