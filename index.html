<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema HX ‚Äî Gest√£o Total</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        :root { --hx-dark: #0d0d0d; --hx-dark2: #151515; --hx-accent: #0aff9d; --hx-text: #eaeaea; --hx-danger: #ff5566; }
        body { margin: 0; background: var(--hx-dark); color: var(--hx-text); font-family: sans-serif; display: flex; }
        #sidebar { width: 240px; background: var(--hx-dark2); height: 100vh; position: fixed; border-right: 1px solid #222; display: flex; flex-direction: column; }
        #sidebar button { background: none; border: none; color: #fff; padding: 15px; text-align: left; cursor: pointer; border-left: 3px solid transparent; }
        #sidebar button.active { background: #1f1f1f; color: var(--hx-accent); border-left-color: var(--hx-accent); }
        main { margin-left: 240px; flex: 1; padding: 30px; }
        .card { background: #181818; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; }
        .btn { padding: 10px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-add { background: var(--hx-accent); color: #000; }
        .btn-del { background: var(--hx-danger); color: #fff; margin-left: 5px; }
        .btn-edit { background: #3498db; color: #fff; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .critical { background: var(--hx-danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #loginOverlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="card" style="width: 300px;">
        <h2 style="text-align:center; color:var(--hx-accent)">SISTEMA HX</h2>
        <input id="lEmail" type="email" placeholder="E-mail" value="admin@hx.com">
        <input id="lPass" type="password" placeholder="Senha">
        <button class="btn btn-add" style="width:100%" onclick="login()">ENTRAR</button>
        <p id="lErr" style="color:var(--hx-danger); font-size:12px; text-align:center"></p>
    </div>
</div>

<nav id="sidebar">
    <div style="padding:20px; font-weight:bold; color:var(--hx-accent)">PAINEL HX</div>
    <button onclick="changeTab('dashTab', this)" class="active">üìä Dashboard</button>
    <button onclick="changeTab('cliTab', this)">üë§ Clientes</button>
    <button onclick="changeTab('estTab', this)">üì¶ Estoque</button>
    <button onclick="changeTab('venTab', this)">üíµ Vendas</button>
</nav>

<main>
    <section id="dashTab">
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;">
            <div class="card">Vendas Hoje <h2 id="vendaDia" style="color:var(--hx-accent)">R$ 0,00</h2></div>
            <div class="card">Vendas M√™s <h2 id="vendaMes" style="color:#00cfff">R$ 0,00</h2></div>
            <div class="card">Estoque Cr√≠tico <h2 id="qtdCritico" style="color:var(--hx-danger)">0 Itens</h2></div>
        </div>
        <div class="card"><canvas id="chartVendas" height="100"></canvas></div>
    </section>

    <section id="cliTab" style="display:none">
        <h2>Cadastro de Clientes</h2>
        <div class="card">
            <input id="cNome" placeholder="Nome Completo">
            <input id="cTel" placeholder="Telefone">
            <button class="btn btn-add" onclick="saveCli()">SALVAR CLIENTE</button>
        </div>
        <div class="card">
            <input id="searchCli" placeholder="üîç Pesquisar cliente por nome..." oninput="renderCli()">
            <div id="listCli" style="margin-top:15px"></div>
        </div>
    </section>

    <section id="estTab" style="display:none">
        <h2>Controle de Estoque</h2>
        <div class="card">
            <input id="pNome" placeholder="Nome do Produto">
            <input id="pQtd" type="number" placeholder="Quantidade">
            <input id="pMin" type="number" placeholder="Estoque M√≠nimo (Alerta)">
            <input id="pCusto" type="number" placeholder="Pre√ßo Custo">
            <input id="pVenda" type="number" placeholder="Pre√ßo Venda">
            <button class="btn btn-add" onclick="saveProd()">ADICIONAR PRODUTO</button>
        </div>
        <div class="card">
            <button class="btn btn-edit" onclick="filterCritical()">VER APENAS ESTOQUE CR√çTICO</button>
            <button class="btn" onclick="renderEst()">VER TUDO</button>
            <div id="listEst" style="margin-top:15px"></div>
        </div>
    </section>

    <section id="venTab" style="display:none">
        <h2>Vendas</h2>
        <div class="card">
            <select id="vCli"></select>
            <select id="vProd"></select>
            <input id="vQtd" type="number" value="1">
            <button class="btn btn-add" onclick="doVenda()">FINALIZAR VENDA</button>
        </div>
        <div class="card">
            <div style="display:flex; gap:10px">
                <input id="sVenNome" placeholder="üîç Por cliente..." oninput="renderVen()">
                <input id="sVenData" type="date" onchange="renderVen()">
            </div>
            <div id="listVen" style="margin-top:15px"></div>
        </div>
    </section>
</main>

<script>
// CONFIGURA√á√ÉO SUPABASE
const { createClient } = window.supabase;
const db = createClient(
    "https://axfccmezfofnqfsdurqb.supabase.co", 
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4ZmNjbWV6Zm9mbnFmc2R1cnFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzA1NDMsImV4cCI6MjA4MDY0NjU0M30.woGp6hBgiEa41opQxyxqqMULlDKMXm9T83bhJ7UEmb8"
);

let _clientes = [], _produtos = [], _vendas = [];
let chartInstance = null;

async function login() {
    const { error } = await db.auth.signInWithPassword({
        email: document.getElementById('lEmail').value,
        password: document.getElementById('lPass').value
    });
    if(error) document.getElementById('lErr').innerText = "Erro: " + error.message;
    else { document.getElementById('loginOverlay').style.display='none'; loadAll(); }
}

function changeTab(id, btn) {
    document.querySelectorAll('main section').forEach(s => s.style.display='none');
    document.getElementById(id).style.display='block';
    document.querySelectorAll('#sidebar button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

async function loadAll() {
    const { data: c } = await db.from('clientes').select('*').order('nome');
    const { data: p } = await db.from('produtos').select('*').order('nome');
    const { data: v } = await db.from('vendas').select('*, clientes(nome), produtos(nome)').order('data', {ascending:false});
    
    _clientes = c || []; _produtos = p || []; _vendas = v || [];
    
    renderCli(); renderEst(); renderVen(); updateDash();
    
    // Preencher selects
    document.getElementById('vCli').innerHTML = _clientes.map(i => `<option value="${i.id}">${i.nome}</option>`).join('');
    document.getElementById('vProd').innerHTML = _produtos.map(i => `<option value="${i.id}">${i.nome} (R$ ${i.preco_revenda})</option>`).join('');
}

// CLIENTES: Pesquisar, Editar, Excluir
function renderCli() {
    const term = document.getElementById('searchCli').value.toLowerCase();
    const filtered = _clientes.filter(x => x.nome.toLowerCase().includes(term));
    document.getElementById('listCli').innerHTML = filtered.map(x => `
        <div style="border-bottom:1px solid #333; padding:10px; display:flex; justify-content:space-between">
            <span><b>${x.nome}</b> - ${x.telefone}</span>
            <div>
                <button class="btn btn-edit" onclick="editCli(${x.id}, '${x.nome}')">‚úèÔ∏è</button>
                <button class="btn btn-del" onclick="delItem('clientes', ${x.id})">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
}

async function saveCli() {
    await db.from('clientes').insert({ nome: document.getElementById('cNome').value, telefone: document.getElementById('cTel').value });
    loadAll();
}

// ESTOQUE: Alerta Cr√≠tico e Filtro
function renderEst() {
    document.getElementById('listEst').innerHTML = _produtos.map(x => {
        const isCrit = x.qnt <= x.estoque_minimo;
        return `
        <div style="border-bottom:1px solid #333; padding:10px; display:flex; justify-content:space-between">
            <span>
                <b>${x.nome}</b> | Qtd: ${x.qnt} 
                ${isCrit ? '<span class="badge critical">‚ö†Ô∏è CR√çTICO</span>' : ''}
            </span>
            <div>
                <button class="btn btn-edit" onclick="editProd(${x.id})">‚úèÔ∏è</button>
                <button class="btn btn-del" onclick="delItem('produtos', ${x.id})">üóëÔ∏è</button>
            </div>
        </div>`;
    }).join('');
}

function filterCritical() {
    const criticos = _produtos.filter(p => p.qnt <= p.estoque_minimo);
    document.getElementById('listEst').innerHTML = criticos.map(x => `
        <div style="border-bottom:1px solid #333; padding:10px; color:var(--hx-danger)">
            <b>${x.nome}</b> - Apenas ${x.qnt} unidades restando!
        </div>
    `).join('');
}

async function saveProd() {
    await db.from('produtos').insert({
        nome: document.getElementById('pNome').value,
        qnt: document.getElementById('pQtd').value,
        estoque_minimo: document.getElementById('pMin').value,
        preco_custo: document.getElementById('pCusto').value,
        preco_revenda: document.getElementById('pVenda').value
    });
    loadAll();
}

// VENDAS: Por Data/Nome, Excluir, Dashboard
function renderVen() {
    const term = document.getElementById('sVenNome').value.toLowerCase();
    const date = document.getElementById('sVenData').value;
    const filtered = _vendas.filter(v => {
        const matchName = v.clientes?.nome.toLowerCase().includes(term);
        const matchDate = date ? v.data.startsWith(date) : true;
        return matchName && matchDate;
    });
    
    document.getElementById('listVen').innerHTML = filtered.map(v => `
        <div style="border-bottom:1px solid #333; padding:10px; display:flex; justify-content:space-between">
            <span>${new Date(v.data).toLocaleDateString()} - <b>${v.clientes.nome}</b>: ${v.produtos.nome} (R$ ${v.valor})</span>
            <button class="btn btn-del" onclick="delItem('vendas', ${v.id})">üóëÔ∏è</button>
        </div>
    `).join('');
}

async function doVenda() {
    const prod = _produtos.find(p => p.id == document.getElementById('vProd').value);
    const qtd = Number(document.getElementById('vQtd').value);
    
    if(prod.qnt < qtd) return alert("Estoque insuficiente!");

    await db.from('vendas').insert({
        cliente_id: document.getElementById('vCli').value,
        produto_id: prod.id,
        quantidade: qtd,
        valor: prod.preco_revenda * qtd,
        data: new Date().toISOString()
    });
    
    await db.from('produtos').update({ qnt: prod.qnt - qtd }).eq('id', prod.id);
    loadAll();
}

async function delItem(table, id) {
    if(confirm("Tem certeza que deseja excluir?")) {
        await db.from(table).delete().eq('id', id);
        loadAll();
    }
}

function updateDash() {
    const hoje = new Date().toISOString().split('T')[0];
    const mes = hoje.substring(0, 7);
    
    const totalHoje = _vendas.filter(v => v.data.startsWith(hoje)).reduce((a, b) => a + b.valor, 0);
    const totalMes = _vendas.filter(v => v.data.startsWith(mes)).reduce((a, b) => a + b.valor, 0);
    const criticos = _produtos.filter(p => p.qnt <= p.estoque_minimo).length;
    
    document.getElementById('vendaDia').innerText = `R$ ${totalHoje.toFixed(2)}`;
    document.getElementById('vendaMes').innerText = `R$ ${totalMes.toFixed(2)}`;
    document.getElementById('qtdCritico').innerText = `${criticos} Itens`;

    const ctx = document.getElementById('chartVendas').getContext('2d');
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: _vendas.slice(0,7).map(v => new Date(v.data).toLocaleDateString()),
            datasets: [{ label: 'Vendas Recentes', data: _vendas.slice(0,7).map(v => v.valor), borderColor: '#0aff9d', tension: 0.4 }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });
}

window.onload = () => { if(db.auth.getSession()) loadAll(); };
</script>
</body>
</html>
