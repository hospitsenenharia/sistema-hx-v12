<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema HX ‚Äî Gest√£o Administrativa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        :root { --hx-dark: #0d0d0d; --hx-dark2: #151515; --hx-accent: #0aff9d; --hx-text: #eaeaea; --hx-danger: #ff5566; }
        body { margin: 0; background: var(--hx-dark); color: var(--hx-text); font-family: 'Segoe UI', sans-serif; display: flex; overflow-x: hidden; }
        
        /* Sidebar */
        #sidebar { width: 240px; background: var(--hx-dark2); height: 100vh; position: fixed; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #sidebar button { background: none; border: none; color: #fff; padding: 15px; text-align: left; cursor: pointer; border-left: 3px solid transparent; transition: 0.3s; }
        #sidebar button.active { background: #1f1f1f; color: var(--hx-accent); border-left-color: var(--hx-accent); }
        
        main { margin-left: 240px; flex: 1; padding: 25px; min-height: 100vh; }
        .card { background: #181818; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        
        /* Dashboard Cards */
        .grid-dash { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .dash-card { background: #181818; padding: 20px; border-radius: 8px; border-left: 4px solid var(--hx-accent); }

        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add { background: var(--hx-accent); color: #000; }
        .btn-del { background: var(--hx-danger); color: #fff; }
        
        /* Login */
        #loginOverlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: #181818; padding: 30px; border-radius: 12px; border: 1px solid var(--hx-accent); width: 320px; }
        
        .critical { color: var(--hx-danger); font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="text-align:center; color:var(--hx-accent); margin-bottom: 20px;">SISTEMA HX</h2>
        <label>E-mail</label>
        <input id="lEmail" type="email" placeholder="admin@hx.com">
        <label>Senha</label>
        <input id="lPass" type="password">
        <button class="btn btn-add" style="width:100%; margin-top: 10px;" onclick="login()">ENTRAR</button>
        <p id="lErr" style="color:var(--hx-danger); font-size:12px; text-align:center; margin-top:10px;"></p>
    </div>
</div>

<nav id="sidebar">
    <div style="padding:20px; font-weight:bold; color:var(--hx-accent); font-size:1.2rem; border-bottom:1px solid #333;">PAINEL HX</div>
    <button onclick="changeTab('dashTab', this)" class="active">üìä Dashboard</button>
    <button onclick="changeTab('cliTab', this)">üë§ Clientes</button>
    <button onclick="changeTab('estTab', this)">üì¶ Estoque</button>
    <button onclick="changeTab('venTab', this)">üíµ Vendas</button>
    <button onclick="changeTab('osTab', this)">üõ† Ordem de Servi√ßo</button>
    <button onclick="changeTab('orcTab', this)">üìù Or√ßamentos</button>
    <button onclick="logout()" style="
  margin-top:auto;
  background:none;
  border:none;
  color:#ff5566;
  padding:15px;
  text-align:left;
  cursor:pointer;
">
  üö™ Sair do Sistema
</button>

</nav>

<main>
    <section id="dashTab">
        <h2 style="color:var(--hx-accent)">üìä Dashboard Financeiro</h2>
        <div class="grid-dash">
            <div class="dash-card">Vendas Hoje <h3 id="vDia" style="color:var(--hx-accent)">R$ 0,00</h3></div>
            <div class="dash-card">Lucro Hoje <h3 id="lDia" style="color:#00cfff">R$ 0,00</h3></div>
            <div class="dash-card">Vendas M√™s <h3 id="vMes">R$ 0,00</h3></div>
            <div class="dash-card">Estoque Cr√≠tico <h3 id="qtdCrit" style="color:var(--hx-danger)">0 Itens</h3></div>
        </div>
        <div class="card"><h4>Hist√≥rico de Vendas Recentes</h4><canvas id="chartDiario" height="100"></canvas></div>
    </section>

    <section id="cliTab" style="display:none">
        <h2>üë§ Gest√£o de Clientes</h2>
        <div class="card">
            <input id="cNome" placeholder="Nome Completo">
            <input id="cTel" placeholder="Telefone">
            <button class="btn btn-add" onclick="saveCli()">CADASTRAR</button>
        </div>
        <div class="card">
            <input id="sCli" placeholder="üîç Pesquisar cliente..." oninput="renderCli()">
            <div id="listCli" style="margin-top:15px"></div>
        </div>
    </section>

    <section id="estTab" style="display:none">
        <h2>üì¶ Controle de Estoque</h2>
        <div class="card">
            <input id="pNome" placeholder="Produto">
            <input id="pQtd" type="number" placeholder="Quantidade">
            <input id="pMin" type="number" placeholder="M√≠nimo para Alerta">
            <input id="pCusto" type="number" placeholder="Pre√ßo Custo">
            <input id="pRev" type="number" placeholder="Pre√ßo Venda">
            <button class="btn btn-add" onclick="saveProd()">ADICIONAR</button>
        </div>
        <div class="card">
  <input
    id="sEstNome"
    placeholder="üîç Pesquisar produto..."
    oninput="renderEst()"
  >
</div>



        
        <div class="card">
            <div id="listEst"></div>
        </div>
    </section>

    <section id="venTab" style="display:none">
  <h2>üíµ Registro de Vendas</h2>

  <!-- FORMUL√ÅRIO DE VENDA -->
  <div class="card">
    <label>Cliente</label>
    <select id="vCliSelect"></select>

    <label>Produto</label>
    <select id="vProdSelect" onchange="recalcularVenda()"></select>

    <label>Quantidade</label>
    <input id="vQtd" type="number" value="1" min="1" oninput="recalcularVenda()">

    <label>Forma de pagamento</label>
    <select id="vPagamento">
      <option value="">Selecione</option>
      <option value="Pix">Pix</option>
      <option value="Dinheiro">Dinheiro</option>
      <option value="Cart√£o">Cart√£o</option>
    </select>

    <input id="vValorManual" type="number" placeholder="Valor manual (opcional)" oninput="recalcularVenda()">
    <input id="vDesconto" type="number" placeholder="Desconto" value="0" oninput="recalcularVenda()">

    <p>Total: <strong id="vTotalLabel">R$ 0,00</strong></p>

    <button class="btn btn-add" onclick="doVenda()">FINALIZAR VENDA</button>
  </div>

  <!-- üîç FILTROS (ESSES ESTAVAM FALTANDO) -->
  <div class="card">
    <input id="sVenNome" placeholder="üîç Filtrar por cliente" oninput="renderVen()">
    <input id="sVenData" type="date" onchange="renderVen()">
  </div>

  <!-- üìã LISTA DE VENDAS -->
  <div class="card">
    <div id="listVen"></div>
  </div>
</section>



    <section id="osTab" style="display:none">
        <h2>üõ† Ordens de Servi√ßo</h2>
        <div class="card">
            <select id="osCliSelect"></select>
            <textarea id="osDesc" placeholder="Descri√ß√£o do problema/servi√ßo..."></textarea>
            <button class="btn btn-add" onclick="saveOS()">ABRIR O.S.</button>
        </div>
        <div id="listOS"></div>
    </section>

    <section id="orcTab" style="display:none">
        <h2>üìù Or√ßamentos</h2>
        <div class="card">
            <select id="orcCliSelect"></select>
            <textarea id="orcDesc" placeholder="Itens e valores do or√ßamento..."></textarea>
            <button class="btn btn-add" onclick="saveOrc()">GERAR OR√áAMENTO</button>
        </div>
        <div id="listOrc"></div>
    </section>
</main>

<script>
// ================= SUPABASE =================
const { createClient } = window.supabase;
const db = createClient(
  "https://axfccmezfofnqfsdurqb.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4ZmNjbWV6Zm9mbnFmc2R1cnFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzA1NDMsImV4cCI6MjA4MDY0NjU0M30.woGp6hBgiEa41opQxyxqqMULlDKMXm9T83bhJ7UEmb8"
);

async function logout() {
  const { error } = await db.auth.signOut();
  if (error) {
    alert("Erro ao sair: " + error.message);
  } else {
    location.reload();
  }
}
// ================= DADOS EM MEM√ìRIA =================
let _clis = [];
let _prods = [];
let _vens = [];
let _oss  = [];
let _orcs = [];

let chartInstance = null;
let prodEditId = null;
// üîΩ CONTROLE DE EDI√á√ÉO DE VENDA
let vendaEditId = null;
let vendaOriginal = null;



// ================= FUN√á√ïES DE RENDER =================
function renderCli() {
  const s = document.getElementById('sCli').value.toLowerCase();
  document.getElementById('listCli').innerHTML =
    _clis
      .filter(c => c.nome.toLowerCase().includes(s))
      .map(c => `
        <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
          <span>${c.nome} - ${c.telefone || 'Sem fone'}</span>
          <div>
            <button class="btn btn-del" onclick="delItem('clientes', ${c.id})">üóëÔ∏è</button>
          </div>
        </div>
      `)
      .join('');
}

// ==================== SALVAR CLIENTE ====================
// ================= SALVAR EDI√á√ÉO (MODAL) =================
async function salvarEdicaoProd() {
  if (!prodEditId) return;

  const { error } = await db
    .from('produtos')
    .update({
      nome: document.getElementById('eNome').value,
      estoque: Number(document.getElementById('eQtd').value),
      estoque_minimo: Number(document.getElementById('eMin').value),
      preco_custo: Number(document.getElementById('eCusto').value),
      preco_revenda: Number(document.getElementById('eRev').value)
    })
    .eq('id', prodEditId);

  if (error) {
    console.error(error);
    alert("Erro ao salvar o produto");
    return;
  }

  fecharModalProd();
  loadAll();
}






// ==================== SALVAR ORDEM DE SERVI√áO ====================
async function saveOS() {
  const cli = document.getElementById('osCliSelect').value;
  const desc = document.getElementById('osDesc').value.trim();

  if (!cli || !desc) {
    alert("Selecione o cliente e informe a descri√ß√£o");
    return;
  }

  await db.from('ordens_servico').insert({
    cliente_id: cli,
    descricao: desc,
    data_abertura: new Date().toISOString()
  });

  document.getElementById('osDesc').value = "";

  loadAll();
}

// ==================== SALVAR OR√áAMENTO ====================
async function saveOrc() {
  const cli = document.getElementById('orcCliSelect').value;
  const desc = document.getElementById('orcDesc').value.trim();

  if (!cli || !desc) {
    alert("Selecione o cliente e descreva o or√ßamento");
    return;
  }

  await db.from('orcamentos').insert({
    cliente_id: cli,
    descricao: desc,
    data: new Date().toISOString()
  });

  document.getElementById('orcDesc').value = "";

  loadAll();
}
   

// ================= LOGIN =================
async function login() {
  const email = document.getElementById('lEmail').value.trim();
  const password = document.getElementById('lPass').value.trim();
  const errEl = document.getElementById('lErr');

  errEl.innerText = "";

  if (!email || !password) {
    errEl.innerText = "Informe e-mail e senha.";
    return;
  }

  const { error } = await db.auth.signInWithPassword({ email, password });

  if (error) {
    errEl.innerText = "Erro: " + error.message;
  } else {
    document.getElementById('loginOverlay').style.display = 'none';
    loadAll();
  }
}



function changeTab(id, btn) {
  const target = document.getElementById(id);
  if (!target) {
    console.warn("Se√ß√£o inexistente:", id);
    return;
  }

  document.querySelectorAll("main section").forEach(s => {
    if (s) s.style.display = "none";
  });

  target.style.display = "block";

  document.querySelectorAll("#sidebar button")
    .forEach(b => b.classList.remove("active"));

  if (btn) btn.classList.add("active");
}



// ================= LOADALL =================
async function loadAll() {
  const { data: clis } = await db.from('clientes').select('*');
  _clis = clis || [];

  const { data: prods } = await db.from('produtos').select('*');
  _prods = prods || [];

  const { data: vens } = await db
    .from('vendas')
    .select('*, clientes(nome), produtos(nome)')
    .order('data_venda', { ascending: false });
  _vens = vens || [];

  const { data: oss } = await db
    .from('ordens_servico')
    .select('*, clientes(nome)');
  _oss = oss || [];

  const { data: orcs } = await db
    .from('orcamentos')
    .select('*, clientes(nome)');
  _orcs = orcs || [];

  
refreshSelects();
renderCli();
renderEst();
renderVen();
renderOS();
renderOrc();
updateDash();
}

    
function refreshSelects() {
  const cliOptions = _clis.map(c =>
    `<option value="${c.id}">${c.nome}</option>`
  ).join("");

  const prodOptions = _prods.map(p =>
    `<option value="${p.id}">${p.nome}</option>`
  ).join("");

  ["vCliSelect", "osCliSelect", "orcCliSelect"]
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = cliOptions;
    });

  ["vProdSelect"]
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = prodOptions;
    });
}

  

// DASHBOARD CALCULATIONS
function updateDash() {
  const agora = new Date();

  const inicioHoje = new Date();
  inicioHoje.setHours(0, 0, 0, 0);

  const fimHoje = new Date();
  fimHoje.setHours(23, 59, 59, 999);

  const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);

  const vendasHoje = _vens.filter(v => {
    const d = new Date(v.data_venda || v.data);
    return d >= inicioHoje && d <= fimHoje;
  });

  const vendasMes = _vens.filter(v => {
    const d = new Date(v.data_venda || v.data);
    return d >= inicioMes;
  });

  const totalHoje = vendasHoje.reduce((s, v) => s + Number(v.valor || 0), 0);
  const lucroHoje = vendasHoje.reduce((s, v) => s + Number(v.lucro_total || 0), 0);
  const totalMes = vendasMes.reduce((s, v) => s + Number(v.valor || 0), 0);

  const criticos = _prods.filter(p =>
    (p.estoque ?? 0) <= (p.estoque_minimo ?? 0)
  ).length;

  document.getElementById('vDia').innerText = `R$ ${totalHoje.toFixed(2)}`;
  document.getElementById('lDia').innerText = `R$ ${lucroHoje.toFixed(2)}`;
  document.getElementById('vMes').innerText = `R$ ${totalMes.toFixed(2)}`;
  document.getElementById('qtdCrit').innerText = `${criticos} Itens`;

  renderChart();
}


function renderChart() {
  const ctx = document.getElementById('chartDiario').getContext('2d');
  if (chartInstance) chartInstance.destroy();

  const ultimasVendas = _vens.slice(0, 7).reverse();

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ultimasVendas.map(v =>
        new Date(v.data_venda || v.data).toLocaleDateString("pt-BR")
      ),
      datasets: [{
        label: 'Vendas Recentes',
        data: ultimasVendas.map(v => v.valor),
        borderColor: '#0aff9d',
        backgroundColor: 'rgba(10, 255, 157, 0.1)',
        tension: 0.3,
        fill: true
      }]
    }
  });
}



async function doVenda() {
  const prod = _prods.find(p =>
    p.id == document.getElementById('vProdSelect').value
  );

  if (!prod) {
    alert("Selecione um produto");
    return;
  }

  const qtd = Number(document.getElementById('vQtd').value || 1);
  const estoqueAtual = prod.estoque ?? 0;

  if (qtd <= 0) {
    alert("Quantidade inv√°lida");
    return;
  }

  if (estoqueAtual < qtd) {
    alert("Estoque insuficiente!");
    return;
  }

  const valorManual = Number(document.getElementById('vValorManual')?.value || 0);
  const desconto = Number(document.getElementById('vDesconto')?.value || 0);
  const formaPagamento = document.getElementById('vPagamento').value;
  const clienteId = document.getElementById('vCliSelect').value;

  if (!clienteId) {
    alert("Selecione um cliente");
    return;
  }

  let valorTotal = valorManual > 0
    ? valorManual
    : prod.preco_revenda * qtd;

  valorTotal -= desconto;
  if (valorTotal < 0) valorTotal = 0;

  const lucro = valorTotal - (prod.preco_custo * qtd);

  // 1Ô∏è‚É£ SALVAR VENDA
  const { error: vendaError } = await db
    .from('vendas')
    .insert({
      cliente_id: clienteId,
      produto_id: prod.id,
      quantidade: qtd,
      valor: valorTotal,
      desconto: desconto || 0,
      forma_pagamento: formaPagamento,
      lucro_total: lucro,
      data_venda: new Date().toISOString()
    });

  if (vendaError) {
    console.error("Erro ao salvar venda:", vendaError);
    alert("Erro ao registrar a venda");
    return;
  }

  // 2Ô∏è‚É£ ATUALIZAR ESTOQUE
  const { error: estoqueError } = await db
    .from('produtos')
    .update({ estoque: estoqueAtual - qtd })
    .eq('id', prod.id);

  if (estoqueError) {
    console.error("Erro ao atualizar estoque:", estoqueError);
    alert("Venda registrada, mas erro ao atualizar estoque");
    return;
  }

  // 3Ô∏è‚É£ SUCESSO
  alert("‚úÖ Venda realizada com sucesso!");

  // 4Ô∏è‚É£ LIMPAR FORMUL√ÅRIO
  document.getElementById('vQtd').value = 1;
  if (document.getElementById('vValorManual')) {
    document.getElementById('vValorManual').value = '';
  }
  if (document.getElementById('vDesconto')) {
    document.getElementById('vDesconto').value = '';
  }

  // 5Ô∏è‚É£ ATUALIZAR TELA
  loadAll();
}



// GENERAL ACTIONS: RENDER, EDIT, DELETE
async function delItem(tab, id) {
    if(confirm("Deseja realmente excluir este registro?")) {
        await db.from(tab).delete().eq('id', id);
        loadAll();
    }
}

function editarVenda(id) {
  const v = _vens.find(x => x.id === id);
  if (!v) return;

  vendaEditId = id;
  vendaOriginal = v;

  // Preenche selects
  document.getElementById('eVendaCliente').innerHTML =
    _clis.map(c => `<option value="${c.id}">${c.nome}</option>`).join("");

  document.getElementById('eVendaProduto').innerHTML =
    _prods.map(p => `<option value="${p.id}">${p.nome}</option>`).join("");

  document.getElementById('eVendaCliente').value = v.cliente_id;
  document.getElementById('eVendaProduto').value = v.produto_id;
  document.getElementById('eVendaQtd').value = v.quantidade;
  document.getElementById('eVendaValor').value = v.valor;
  document.getElementById('eVendaDesconto').value = v.desconto || 0;
  document.getElementById('eVendaPagamento').value = v.forma_pagamento || "Pix";

  document.getElementById('eVendaData').value =
    new Date(v.data_venda).toISOString().slice(0,16);

  document.getElementById('modalEditVenda').style.display = "flex";
}


async function salvarEdicaoVenda() {
  if (!vendaEditId || !vendaOriginal) return;

  const novoProdutoId = document.getElementById('eVendaProduto').value;
  const novaQtd = Number(document.getElementById('eVendaQtd').value);
  const novoValor = Number(document.getElementById('eVendaValor').value);
  const novoDesconto = Number(document.getElementById('eVendaDesconto').value || 0);
  const novaForma = document.getElementById('eVendaPagamento').value;
  const novaData = document.getElementById('eVendaData').value;
  const novoClienteId = document.getElementById('eVendaCliente').value;

  // 1Ô∏è‚É£ DEVOLVER ESTOQUE DA VENDA ORIGINAL
  const { data: prodAntigo } = await db
    .from('produtos')
    .select('estoque')
    .eq('id', vendaOriginal.produto_id)
    .single();

  await db.from('produtos')
    .update({
      estoque: (prodAntigo.estoque ?? 0) + vendaOriginal.quantidade
    })
    .eq('id', vendaOriginal.produto_id);

  // 2Ô∏è‚É£ VALIDAR NOVO PRODUTO
  const prodNovo = _prods.find(p => p.id == novoProdutoId);
  if (!prodNovo || prodNovo.estoque < novaQtd) {
    alert("Estoque insuficiente");
    return;
  }

  // 3Ô∏è‚É£ DEBITAR NOVO ESTOQUE
  await db.from('produtos')
    .update({ estoque: prodNovo.estoque - novaQtd })
    .eq('id', novoProdutoId);

  // 4Ô∏è‚É£ RECALCULAR LUCRO
  const lucro =
    novoValor - ((prodNovo.preco_custo || 0) * novaQtd);

  // 5Ô∏è‚É£ ATUALIZAR VENDA
  await db.from('vendas')
    .update({
      cliente_id: novoClienteId,
      produto_id: novoProdutoId,
      quantidade: novaQtd,
      valor: novoValor,
      desconto: novoDesconto,
      forma_pagamento: novaForma,
      lucro_total: lucro,
      data_venda: new Date(novaData).toISOString()
    })
    .eq('id', vendaEditId);

  // 6Ô∏è‚É£ FINALIZAR
  fecharModalVenda();
  loadAll();
}




function fecharModalVenda() {
  vendaEditId = null;
  vendaOriginal = null;
  document.getElementById('modalEditVenda').style.display = "none";
}



//==================== RENDER VENDAS ====================
function renderVen()
{
  const sNome =
    document.getElementById('sVenNome')?.value?.toLowerCase() || "";

  const sData =
    document.getElementById('sVenData')?.value || "";

  document.getElementById('listVen').innerHTML = _vens
    .filter(v =>
      (v.clientes?.nome?.toLowerCase().includes(sNome)) &&
      (sData ? (v.data_venda || v.data).startsWith(sData) : true)
    )
    .map(v => `
      <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
        <span>
          ${(v.data_venda || v.data).split('T')[0]}
          <strong>${v.clientes?.nome}</strong><br>
          ${v.produtos?.nome} | Qtd: ${v.quantidade} | R$ ${Number(v.valor).toFixed(2)}
        </span>

        <div style="display:flex; gap:6px;">
          <button class="btn btn-add" onclick="editarVenda(${v.id})">‚úèÔ∏è</button>
          <button class="btn btn-add" onclick="imprimirVenda(${v.id})">üñ®Ô∏è</button>
          <button class="btn btn-del" onclick="delItem('vendas', ${v.id})">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
}


// ==================== RENDER OR√áAMENTO  ====================

 function renderOrc() {
  const el = document.getElementById('listOrc');
  if (!el) return;

  el.innerHTML = _orcs.map(o => `
    <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
      <span>
        <strong>${o.clientes?.nome || 'Sem cliente'}</strong><br>
        ${o.descricao || ''}
      </span>
      <div>
        <button class="btn btn-add" onclick="imprimirOrc(${o.id})">üñ®Ô∏è</button>
        <button class="btn btn-del" onclick="delItem('orcamentos', ${o.id})">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}


// ==================== RENDER ORDEM DE SERVI√áO ====================
// ==================== RENDER ORDEM DE SERVI√áO ====================
function renderOS() {
  const el = document.getElementById('listOS');
  if (!el) return;

  el.innerHTML = _oss.map(o => `
    <div style="
      padding:10px;
      border-bottom:1px solid #333;
      display:flex;
      justify-content:space-between;
      align-items:center;
    ">
      <span>
        <strong>${o.clientes?.nome || 'Sem cliente'}</strong><br>
        ${o.descricao || ''}
      </span>

      <div style="display:flex; gap:6px;">
        <button class="btn btn-add" onclick="imprimirOS(${o.id})">üñ®Ô∏è</button>
        <button class="btn btn-del" onclick="delItem('ordens_servico', ${o.id})">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}


// ==================== IMPRIMIR VENDA ====================
function imprimirVenda(id) {
  const v = _vens.find(x => x.id === id);
  if (!v) {
    alert("Venda n√£o encontrada");
    return;
  }

  const w = window.open("", "_blank", "width=300,height=600");

  w.document.write(`
<html>
<head>
  <meta charset="utf-8">
  <title>Cupom</title>
  <style>
    body {
      font-family: monospace;
      font-size: 12px;
      width: 80mm;
      margin: 0;
      padding: 5px;
    }
    .center {
      text-align: center;
    }
    hr {
      border: none;
      border-top: 1px dashed #000;
      margin: 6px 0;
    }
  </style>
</head>

<body onload="window.print(); window.close()">

  <div class="center">
    <strong>HX ACESS√ìRIOS & ELETR√îNICOS</strong><br>
    CNPJ: 61.331.523/0001-05<br>
    Av. Mamede Paes Mendon√ßa, 752<br>
    Aracaju - SE<br>
    Contato: (79) 99819-6955
  </div>

  <hr>

  <div class="center">
    <strong>CUPOM N√ÉO FISCAL</strong>
  </div>

  <hr>

  Cliente: ${v.clientes?.nome || "-"}<br>
  Produto: ${v.produtos?.nome || "-"}<br>
  Quantidade: ${v.quantidade}<br>
  Total: R$ ${Number(v.valor).toFixed(2)}<br>
  Forma: ${v.forma_pagamento || "-"}<br>
  Data: ${new Date(v.data_venda || v.data).toLocaleString("pt-BR")}

  <hr>

  <div class="center">
    Obrigado pela prefer√™ncia
  </div>

</body>
</html>
`);

w.document.close();

}
function imprimirOS(id) {
  const os = _oss.find(o => o.id === id);
  if (!os) {
    alert("Ordem de servi√ßo n√£o encontrada");
    return;
  }

  const w = window.open("", "_blank", "width=300,height=600");

  w.document.write(`
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ordem de Servi√ßo</title>
  <style>
    body {
      font-family: monospace;
      font-size: 12px;
      width: 80mm;
      margin: 0;
      padding: 5px;
    }
    .center { text-align: center; }
    hr {
      border: none;
      border-top: 1px dashed #000;
      margin: 6px 0;
    }
  </style>
</head>

<body onload="window.print(); window.close()">

  <div class="center">
    <strong>HX ACESS√ìRIOS & ELETR√îNICOS</strong><br>
    CNPJ: 61.331.523/0001-05<br>
    Av. Mamede Paes Mendon√ßa, 752<br>
    Aracaju - SE<br>
    Contato: (79) 99819-6955
  </div>

  <hr>

  <div class="center">
    <strong>ORDEM DE SERVI√áO</strong>
  </div>

  <hr>

  Cliente: ${os.clientes?.nome || "-"}<br>
  Data: ${new Date(os.data_abertura).toLocaleString("pt-BR")}<br>

  <hr>

  <strong>Descri√ß√£o:</strong><br>
  ${os.descricao || "-"}

  <hr>

  <div>
    Assinatura do cliente:<br><br>
    _______________________________
  </div>

</body>
</html>
`);

  w.document.close();
}

    
function imprimirOrc(id) {
  const o = _orcs.find(x => x.id === id);
  if (!o) {
    alert("Or√ßamento n√£o encontrado");
    return;
  }

  const w = window.open("", "_blank", "width=300,height=600");

  w.document.write(`
<html>
<head>
  <meta charset="utf-8">
  <title>Or√ßamento</title>
  <style>
    body {
      font-family: monospace;
      font-size: 12px;
      width: 80mm;
      margin: 0;
      padding: 5px;
    }
    .center { text-align: center; }
    hr {
      border: none;
      border-top: 1px dashed #000;
      margin: 6px 0;
    }
  </style>
</head>

<body onload="window.print(); window.close()">

  <div class="center">
    <strong>HX ACESS√ìRIOS & ELETR√îNICOS</strong><br>
    CNPJ: 61.331.523/0001-05<br>
    Av. Mamede Paes Mendon√ßa, 752<br>
    Aracaju - SE<br>
    Contato: (79) 99819-6955
  </div>

  <hr>

  <div class="center">
    <strong>OR√áAMENTO</strong>
  </div>

  <hr>

  Cliente: ${o.clientes?.nome || "-"}<br><br>
  ${o.descricao || ''}

  <hr>

  <div class="center">
    Validade do or√ßamento: 7 dias
  </div>

</body>
</html>
`);

  w.document.close();
}


// ==================== ESTOQUE ====================

// RENDER ESTOQUE COM ALERTA
function renderEst() {
  const termo =
    document.getElementById('sEstNome')?.value?.toLowerCase() || "";

  document.getElementById('listEst').innerHTML = _prods
    .filter(p =>
      p.nome?.toLowerCase().includes(termo)
    )
    .map(p => {
      const estoque = p.estoque ?? 0;
      const critico = estoque <= (p.estoque_minimo ?? 0);

      return `
        <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; ${critico ? 'color:var(--hx-danger)' : ''}">
          <span>
            ${p.nome} | Estoque: <strong>${estoque}</strong>
            ${critico ? '<span class="critical"> ‚ö†Ô∏è BAIXO</span>' : ''}
          </span>

          <div>
            <button class="btn btn-add" onclick="editProd(${p.id})">‚úèÔ∏è</button>
            <button class="btn btn-del" onclick="delItem('produtos', ${p.id})">üóëÔ∏è</button>
          </div>
        </div>
      `;
    })
    .join('');
}


// ================= EDITAR PRODUTO (MODAL) =================
function editProd(id) {
  const p = _prods.find(x => x.id === id);
  if (!p) return;

  prodEditId = id;

  document.getElementById('eNome').value  = p.nome || "";
  document.getElementById('eQtd').value = p.estoque ?? 0;
  document.getElementById('eMin').value   = p.estoque_minimo || 0;
  document.getElementById('eCusto').value = p.preco_custo || 0;
  document.getElementById('eRev').value   = p.preco_revenda || 0;

  document.getElementById("modalEditProd").style.display = "flex";
}

// ================= FECHAR MODAL =================
function fecharModalProd() {
  prodEditId = null;
  document.getElementById("modalEditProd").style.display = "none";
}


async function saveCli() {
  const nome = document.getElementById('cNome').value.trim();
  const telefone = document.getElementById('cTel').value.trim();

  if (!nome) {
    alert("Informe o nome do cliente");
    return;
  }

  const { error } = await db
    .from('clientes')
    .insert({
      nome: nome,
      telefone: telefone || null
    });

  if (error) {
    console.error("Erro ao salvar cliente:", error);
    alert("Erro ao cadastrar cliente");
    return;
  }

  // ‚úÖ atualiza lista e selects
  loadAll();
}


async function saveProd() {
  const nome = document.getElementById('pNome').value.trim();
  const estoque = Number(document.getElementById('pQtd').value);
  const estoqueMin = Number(document.getElementById('pMin').value);
  const precoCusto = Number(document.getElementById('pCusto').value);
  const precoRevenda = Number(document.getElementById('pRev').value);

  if (!nome) {
    alert("Informe o nome do produto");
    return;
  }

  const { error } = await db
    .from('produtos')
    .insert({
      nome: nome,
      estoque: estoque || 0,
      estoque_minimo: estoqueMin || 0,
      preco_custo: precoCusto || 0,
      preco_revenda: precoRevenda || 0
    });

  if (error) {
    console.error("Erro ao salvar produto:", error);
    alert("Erro ao cadastrar produto");
    return;
  }

  // Limpa formul√°rio
  document.getElementById('pNome').value = "";
  document.getElementById('pQtd').value = "";
  document.getElementById('pMin').value = "";
  document.getElementById('pCusto').value = "";
  document.getElementById('pRev').value = "";

  loadAll();
}



function recalcularVenda() {
  const prodId = document.getElementById('vProdSelect').value;
  const qtd = Number(document.getElementById('vQtd').value || 1);
  const valorManual = Number(document.getElementById('vValorManual').value || 0);
  const desconto = Number(document.getElementById('vDesconto').value || 0);

  let total = 0;

  if (valorManual > 0) {
    total = valorManual;
  } else {
    const prod = _prods.find(p => p.id == prodId);
    if (!prod) {
      document.getElementById('vTotalLabel').innerText = "R$ 0,00";
      return;
    }
    total = prod.preco_revenda * qtd;
  }

  total -= desconto;
  if (total < 0) total = 0;

  document.getElementById('vTotalLabel').innerText =
    `R$ ${total.toFixed(2)}`;
}



// ================= ONLOAD =================
window.onload = async () => {
  const { data } = await db.auth.getSession();
  if (data.session) loadAll();
};
</script>

<!-- MODAL DE EDI√á√ÉO DE PRODUTO -->
<div id="modalEditProd" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#181818;
    padding:20px;
    border-radius:8px;
    width:400px;
    border:1px solid #0aff9d;
  ">
    <h3 style="color:#0aff9d">‚úèÔ∏è Editar Produto</h3>

    <input id="eNome" placeholder="Produto">
    <input id="eQtd" type="number" placeholder="Quantidade">
    <input id="eMin" type="number" placeholder="M√≠nimo">
    <input id="eCusto" type="number" placeholder="Pre√ßo Custo">
    <input id="eRev" type="number" placeholder="Pre√ßo Venda">

    <div style="display:flex; gap:10px; margin-top:10px;">
      <button class="btn btn-add" onclick="salvarEdicaoProd()">SALVAR</button>
      <button class="btn btn-del" onclick="fecharModalProd()">CANCELAR</button>
    </div>
  </div>
</div>

<div id="modalEditVenda" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#181818;
    padding:20px;
    border-radius:8px;
    width:420px;
    border:1px solid #0aff9d;
  ">
    <h3 style="color:#0aff9d">‚úèÔ∏è Editar Venda</h3>

    <label>Cliente</label>
    <select id="eVendaCliente"></select>

    <label>Produto</label>
    <select id="eVendaProduto"></select>

    <label>Quantidade</label>
    <input id="eVendaQtd" type="number" min="1">

    <label>Forma de pagamento</label>
    <select id="eVendaPagamento">
      <option value="Pix">Pix</option>
      <option value="Dinheiro">Dinheiro</option>
      <option value="Cart√£o">Cart√£o</option>
    </select>

    <label>Valor</label>
    <input id="eVendaValor" type="number">

    <label>Desconto</label>
    <input id="eVendaDesconto" type="number">

    <label>Data e hora</label>
    <input id="eVendaData" type="datetime-local">

    <div style="display:flex; gap:10px; margin-top:15px;">
      <button class="btn btn-add" onclick="salvarEdicaoVenda()">SALVAR</button>
      <button class="btn btn-del" onclick="fecharModalVenda()">CANCELAR</button>
    </div>
  </div>
</div>


</body>
</html>











































