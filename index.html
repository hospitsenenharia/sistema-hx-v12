<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema HX ‚Äî Administra√ß√£o Completa</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      "https://axfccmezfofnqfsdurqb.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4ZmNjbWV6Zm9mbnFmc2R1cnFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzA1NDMsImV4cCI6MjA4MDY0NjU0M30.woGp6hBgiEa41opQxyxqqMULlDKMXm9T83bhJ7UEmb8"
    );
    window.supabase = supabaseClient;
  </script>

  <style>
    :root {
      --hx-dark: #0d0d0d; --hx-dark2: #151515; --hx-dark3: #1f1f1f;
      --hx-accent: #0aff9d; --hx-text: #eaeaea; --hx-card: #181818; --hx-danger: #ff5566;
    }
    body.light { --hx-dark: #f5f5f5; --hx-dark2: #ffffff; --hx-dark3: #e0e0e0; --hx-text: #111111; --hx-card: #ffffff; }
    body { margin: 0; background: var(--hx-dark); color: var(--hx-text); font-family: "Segoe UI", sans-serif; }
    canvas { max-height: 220px !important; width: 100% !important; }

    /* ALERTAS */
    .alerta-critico {
      border: 2px solid var(--hx-danger) !important;
      background: rgba(255, 85, 102, 0.1) !important;
      animation: flash 2s infinite;
    }
    @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    #loginOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.88); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .login-card { background: #111; width: 340px; padding: 25px; border-radius: 12px; color: white; border: 1px solid var(--hx-accent); }
    .login-card input { width: 100%; padding: 10px; margin-top: 6px; background: #222; border: 1px solid #444; border-radius: 8px; color: white; }
    header { padding: 16px; background: var(--hx-dark2); color: var(--hx-accent); display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: bold; }
    #sidebar { position: fixed; top: 0; left: 0; padding-top: 80px; width: 240px; height: 100vh; background: var(--hx-dark2); }
    #sidebar button { width: 100%; background: none; border: none; color: var(--hx-text); padding: 14px; text-align: left; cursor: pointer; }
    .menu-active { background: var(--hx-accent) !important; color: black !important; }
    main { margin-left: 260px; padding: 22px; }
    .card { background: var(--hx-card); padding: 12px; border-radius: 12px; margin-bottom: 20px; }
    input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #333; background: var(--hx-dark3); color: var(--hx-text); margin-bottom: 12px; }
    .btn { background: var(--hx-accent); color: black; padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

  <div id="loginOverlay">
    <div class="login-card">
      <h2 style="text-align:center;">üîí Acesso Sistema HX</h2>
      <label>Email</label><input id="loginEmail" type="email">
      <label>Senha</label><input id="loginPass" type="password">
      <button class="login-btn btn" style="width:100%; margin-top:10px;" onclick="login()">Entrar</button>
      <div id="loginMsg" style="text-align:center; margin-top:10px;"></div>
    </div>
  </div>

  <header>
    <img src="https://i.imgur.com/8Tqj0MW.png" height="40"> Sistema HX ‚Äî Painel Administrativo
    <span id="userLabel" style="margin-left:auto; font-size:14px; color:var(--hx-accent);"></span>
  </header>

  <div id="sidebar">
    <button onclick="showSection('dashboardSec', this)" class="menu-active">üìä Dashboard</button>
    <button onclick="showSection('clientesSec', this)">üë§ Clientes</button>
    <button onclick="showSection('produtosSec', this)">üì¶ Estoque</button>
    <button onclick="showSection('vendasSec', this)">üíµ Vendas</button>
    <button onclick="showSection('osSec', this)">üõ† OS</button>
    <button onclick="showSection('orcamentoSec', this)">üìù Or√ßamentos</button>
    <button onclick="logout()" class="btn" style="background:#444; color:white; width:90%; margin:20px 5% 0 5%;">Sair</button>
  </div>

  <main>
    <section id="dashboardSec">
      <h2>üìä Dashboard Financeiro</h2>
      
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
        <div class="card" style="border-left: 5px solid var(--hx-accent);">
          <h3>Vendas Hoje</h3>
          <div id="fatHoje" style="font-size:24px; font-weight:bold; color:var(--hx-accent);">R$ 0,00</div>
        </div>
        <div class="card" style="border-left: 5px solid #00cfff;">
          <h3>Lucro Hoje</h3>
          <div id="lucHoje" style="font-size:24px; font-weight:bold; color:#00cfff;">R$ 0,00</div>
        </div>
        <div id="cardLucroMes" class="card" style="border-left: 5px solid #ffaa00;">
          <h3>Lucro do M√™s</h3>
          <div id="lucMes" style="font-size:24px; font-weight:bold; color:#ffaa00;">R$ 0,00</div>
        </div>
        <div id="cardEstoque" class="card" style="border-left: 5px solid var(--hx-danger);">
          <h3>Estoque Cr√≠tico</h3>
          <div id="qtdCritica" style="font-size:24px; font-weight:bold; color:var(--hx-danger);">0 Itens</div>
        </div>
      </div>

      <div id="alertasEstoque"></div>

      <div class="card">
        <h3>Faturamento Di√°rio</h3>
        <canvas id="grafVendasDiarias"></canvas>
      </div>
    </section>

    <section id="clientesSec" style="display:none;">
      <h2>üë§ Clientes</h2>
      <div class="card">
        <input id="cliNome" placeholder="Nome">
        <input id="cliTel" placeholder="Telefone">
        <button class="btn" onclick="salvarCliente()">Salvar Cliente</button>
      </div>
      <div id="listaClientes"></div>
    </section>

    <section id="produtosSec" style="display:none;">
      <h2>üì¶ Estoque</h2>
      <div class="card">
        <input id="prodNome" placeholder="Nome do Produto">
        <input id="prodCusto" type="number" placeholder="Custo">
        <input id="prodRevenda" type="number" placeholder="Venda">
        <input id="prodQtd" type="number" placeholder="Quantidade">
        <input id="prodMin" type="number" placeholder="Estoque M√≠nimo">
        <button class="btn" onclick="salvarProduto()">Salvar Produto</button>
      </div>
      <div id="listaProdutos"></div>
    </section>

    <section id="vendasSec" style="display:none;">
      <h2>üíµ Registrar Venda</h2>
      <div class="card">
        <select id="venCliente"></select>
        <select id="venProduto"></select>
        <input id="venQtd" type="number" value="1">
        <input id="venValor" type="number" placeholder="Valor Pago">
        <button class="btn" onclick="registrarVenda()">Finalizar Venda</button>
      </div>
      <div id="listaVendas"></div>
    </section>
    
    <section id="osSec" style="display:none;"><h2>üõ† OS</h2><div id="listaOS"></div></section>
    <section id="orcamentoSec" style="display:none;"><h2>üìù Or√ßamentos</h2><div id="listaOrcamentos"></div></section>
  </main>

<script>
  // --- L√ìGICA DE DASHBOARD COM LUCRO MENSAL E ALERTA VERMELHO ---
  async function carregarDashboard() {
    const { data: vendas } = await supabase.from("vendas").select("*");
    
    const hojeBR = new Date().toLocaleDateString('pt-BR');
    const mesAtual = new Date().toISOString().slice(0, 7);

    let fatHoje = 0, lucHoje = 0, lucMes = 0;

    vendas.forEach(v => {
      const dataV = new Date(v.data);
      const dataVBR = dataV.toLocaleDateString('pt-BR');
      const mesV = v.data.slice(0, 7);

      if (dataVBR === hojeBR) {
        fatHoje += Number(v.valor || 0);
        lucHoje += Number(v.lucro_total || 0);
      }
      if (mesV === mesAtual) {
        lucMes += Number(v.lucro_total || 0);
      }
    });

    document.getElementById('fatHoje').innerText = "R$ " + fatHoje.toFixed(2);
    document.getElementById('lucHoje').innerText = "R$ " + lucHoje.toFixed(2);
    document.getElementById('lucMes').innerText = "R$ " + lucMes.toFixed(2);
  }

  async function carregarEstoqueCriticoDashboard() {
    const { data: produtos } = await supabase.from("produtos").select("*");
    const criticos = produtos.filter(p => Number(p.qtd || 0) <= Number(p.estoque_minimo || 0));
    
    const displayQtd = document.getElementById("qtdCritica");
    const container = document.getElementById("alertasEstoque");
    const cardEstoque = document.getElementById("cardEstoque");

    displayQtd.innerText = `${criticos.length} Itens`;
    container.innerHTML = "";

    if (criticos.length > 0) {
      cardEstoque.classList.add('alerta-critico'); // Destaque em vermelho no card
      criticos.forEach(p => {
        container.innerHTML += `
          <div class="card alerta-critico">
            <b style="color:var(--hx-danger);">‚ö† ESTOQUE CR√çTICO: ${p.nome}</b><br>
            Dispon√≠vel: ${p.qtd} | M√≠nimo: ${p.estoque_minimo}
          </div>`;
      });
    } else {
      cardEstoque.classList.remove('alerta-critico');
    }
  }

  // --- FUN√á√ïES DE NAVEGA√á√ÉO E AUTH ---
  function showSection(id, btn) {
    document.querySelectorAll("main section").forEach(s => s.style.display = "none");
    document.getElementById(id).style.display = "block";
    document.querySelectorAll("#sidebar button").forEach(b => b.classList.remove("menu-active"));
    if(btn) btn.classList.add("menu-active");
  }

  async function login() {
    const { error } = await supabase.auth.signInWithPassword({ email: loginEmail.value, password: loginPass.value });
    if (error) loginMsg.innerText = error.message;
    else location.reload();
  }

  async function logout() { await supabase.auth.signOut(); location.reload(); }

  // --- CARREGAMENTO INICIAL ---
  async function atualizarTudo() {
    await carregarDashboard();
    await carregarEstoqueCriticoDashboard();
    // Chamar outras fun√ß√µes de carregamento (clientes, produtos, etc)
    carregarClientes(); carregarProdutos();
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('userLabel').innerText = session.user.email;
      atualizarTudo();
    }
  });

  // Fun√ß√µes CRUD simplificadas para funcionamento
  async function salvarCliente() {
    await supabase.from("clientes").insert({ nome: cliNome.value, telefone: cliTel.value });
    atualizarTudo();
  }
  async function salvarProduto() {
    await supabase.from("produtos").insert({ 
      nome: prodNome.value, preco_custo: prodCusto.value, 
      preco_revenda: prodRevenda.value, qtd: prodQtd.value, estoque_minimo: prodMin.value 
    });
    atualizarTudo();
  }
</script>
</body>
</html>
