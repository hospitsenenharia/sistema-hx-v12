<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema HX â€” GestÃ£o Administrativa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        :root { --hx-dark: #0d0d0d; --hx-dark2: #151515; --hx-accent: #0aff9d; --hx-text: #eaeaea; --hx-danger: #ff5566; }
        body { margin: 0; background: var(--hx-dark); color: var(--hx-text); font-family: 'Segoe UI', sans-serif; display: flex; overflow-x: hidden; }
        
        /* Sidebar */
        #sidebar { width: 240px; background: var(--hx-dark2); height: 100vh; position: fixed; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #sidebar button { background: none; border: none; color: #fff; padding: 15px; text-align: left; cursor: pointer; border-left: 3px solid transparent; transition: 0.3s; }
        #sidebar button.active { background: #1f1f1f; color: var(--hx-accent); border-left-color: var(--hx-accent); }
        
        main { margin-left: 240px; flex: 1; padding: 25px; min-height: 100vh; }
        .card { background: #181818; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        
        /* Dashboard Cards */
        .grid-dash { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .dash-card { background: #181818; padding: 20px; border-radius: 8px; border-left: 4px solid var(--hx-accent); }

        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add { background: var(--hx-accent); color: #000; }
        .btn-del { background: var(--hx-danger); color: #fff; }
        
        /* Login */
        #loginOverlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: #181818; padding: 30px; border-radius: 12px; border: 1px solid var(--hx-accent); width: 320px; }
        
        .critical { color: var(--hx-danger); font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<!-- ================= LOGIN ================= -->
<div id="loginOverlay">
  <div class="login-card">
    <h2 style="text-align:center; color:var(--hx-accent)">SISTEMA HX</h2>

    <label>E-mail</label>
    <input id="lEmail" type="email">

    <label>Senha</label>
    <input id="lPass" type="password">

    <button class="btn btn-add" style="width:100%" onclick="login()">ENTRAR</button>
    <p id="lErr" style="color:#ff5566; font-size:12px; text-align:center"></p>
  </div>
</div>

<!-- ================= SIDEBAR ================= -->
<nav id="sidebar">
  <div style="padding:20px; font-weight:bold; color:var(--hx-accent)">
    PAINEL HX
  </div>

  <button onclick="changeTab('dashTab', this)" class="active">ğŸ“Š Dashboard</button>
  <button onclick="changeTab('cliTab', this)">ğŸ‘¤ Clientes</button>
  <button onclick="changeTab('estTab', this)">ğŸ“¦ Estoque</button>
  <button onclick="changeTab('venTab', this)">ğŸ’µ Vendas</button>
  <button onclick="changeTab('osTab', this)">ğŸ›  OS</button>
  <button onclick="changeTab('orcTab', this)">ğŸ“ OrÃ§amentos</button>

  <button onclick="logout()" style="margin-top:auto; color:#ff5566">
    ğŸšª Sair
  </button>
</nav>

<!-- ================= CONTEÃšDO ================= -->
<main>

<!-- DASHBOARD -->
<section id="dashTab">
  <h2 style="color:var(--hx-accent)">ğŸ“Š Dashboard Financeiro</h2>

  <div class="grid-dash">
    <div class="dash-card">Vendas Hoje <h3 id="vDia">R$ 0,00</h3></div>
    <div class="dash-card">Lucro Hoje <h3 id="lDia">R$ 0,00</h3></div>
    <div class="dash-card">Vendas MÃªs <h3 id="vMes">R$ 0,00</h3></div>
    <div class="dash-card">Lucro MÃªs <h3 id="lMes">R$ 0,00</h3></div>
    <div class="dash-card">Estoque CrÃ­tico <h3 id="qtdCrit">0</h3></div>
  </div>

  <div class="card">
    <h4>HistÃ³rico de Vendas</h4>
    <canvas id="chartDiario"></canvas>
  </div>
</section>

<!-- CLIENTES -->
<section id="cliTab" style="display:none">
  <h2>ğŸ‘¤ Clientes</h2>
  <div id="listCli"></div>
</section>

<!-- ESTOQUE -->
<section id="estTab" style="display:none">
  <h2>ğŸ“¦ Estoque</h2>
  <div id="listEst"></div>
</section>

<!-- VENDAS -->
<section id="venTab" style="display:none">
  <h2>ğŸ’µ Vendas</h2>

  <div class="card">
    <select id="vCliSelect"></select>
    <select id="vProdSelect" onchange="updateVendaPrice()"></select>
    <input id="vQtd" type="number" value="1" min="1" oninput="updateVendaPrice()">

    <p>Total: <strong id="vTotalLabel">R$ 0,00</strong></p>

    <select id="vTipoPagamento">
      <option value="">Forma de pagamento</option>
      <option value="Pix">Pix</option>
      <option value="Dinheiro">Dinheiro</option>
      <option value="CartÃ£o">CartÃ£o</option>
    </select>

    <button class="btn btn-add" onclick="doVenda()">FINALIZAR</button>
  </div>

  <div id="listVen"></div>
</section>

<!-- OS -->
<section id="osTab" style="display:none">
  <h2>ğŸ›  Ordens de ServiÃ§o</h2>
  <div id="listOS"></div>
</section>

<!-- ORÃ‡AMENTOS -->
<section id="orcTab" style="display:none">
  <h2>ğŸ“ OrÃ§amentos</h2>
  <div id="listOrc"></div>
</section>

</main>

<!-- ================= SCRIPT ÃšNICO ================= -->
<script>
/* ========= SUPABASE ========= */
const { createClient } = window.supabase;
const db = createClient("SUA_URL_SUPABASE", "SUA_KEY");

/* ========= VARIÃVEIS ========= */
let _clis=[], _prods=[], _vens=[], _oss=[], _orcs=[];
let chartInstance=null;

/* ========= LOGIN / LOGOUT ========= */
async function login(){
  const { error } = await db.auth.signInWithPassword({
    email:lEmail.value, password:lPass.value
  });
  if(error) lErr.innerText = error.message;
  else { loginOverlay.style.display="none"; loadAll(); }
}

async function logout(){
  await db.auth.signOut();
  loginOverlay.style.display="flex";
}

/* ========= TABS ========= */
function changeTab(id, btn){
  document.querySelectorAll("main section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll("#sidebar button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

/* ========= LOAD ========= */
async function loadAll(){
  const [{data:c},{data:p},{data:v}] = await Promise.all([
    db.from("clientes").select("*"),
    db.from("produtos").select("*"),
    db.from("vendas").select("*,clientes(nome),produtos(nome)").order("data",{ascending:false})
  ]);
  _clis=c||[]; _prods=p||[]; _vens=v||[];
  refreshSelects(); renderVen(); updateDash(); renderChart();
}

/* ========= SELECTS ========= */
function refreshSelects(){
  vCliSelect.innerHTML=_clis.map(c=>`<option value="${c.id}">${c.nome}</option>`).join("");
  vProdSelect.innerHTML=_prods.map(p=>`<option value="${p.id}">${p.nome}</option>`).join("");
}

/* ========= DASH ========= */
function updateDash(){
  let tH=0,lH=0,tM=0,lM=0;
  const hoje=new Date();
  _vens.forEach(v=>{
    const d=new Date(v.data);
    if(d.toDateString()===hoje.toDateString()){ tH+=v.valor; lH+=v.lucro_total; }
    if(d.getMonth()===hoje.getMonth()&&d.getFullYear()===hoje.getFullYear()){
      tM+=v.valor; lM+=v.lucro_total;
    }
  });
  vDia.innerText=`R$ ${tH.toFixed(2)}`;
  lDia.innerText=`R$ ${lH.toFixed(2)}`;
  vMes.innerText=`R$ ${tM.toFixed(2)}`;
  lMes.innerText=`R$ ${lM.toFixed(2)}`;
}

/* ========= GRÃFICO ========= */
function renderChart(){
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(chartDiario,{
    type:"line",
    data:{
      labels:_vens.slice(0,7).reverse().map(v=>new Date(v.data).toLocaleDateString()),
      datasets:[{data:_vens.slice(0,7).reverse().map(v=>v.valor),borderColor:"#0aff9d"}]
    }
  });
}

/* ========= VENDAS ========= */
function updateVendaPrice(){
  const p=_prods.find(x=>x.id==vProdSelect.value);
  if(p) vTotalLabel.innerText=`R$ ${(p.preco_revenda*vQtd.value).toFixed(2)}`;
}

async function doVenda(){
  const p=_prods.find(x=>x.id==vProdSelect.value);
  await db.from("vendas").insert({
    cliente_id:vCliSelect.value,
    produto_id:p.id,
    quantidade:vQtd.value,
    valor:p.preco_revenda*vQtd.value,
    lucro_total:0,
    tipo_pagamento:vTipoPagamento.value,
    data:new Date().toISOString()
  });
  loadAll();
}

/* ========= IMPRIMIR ========= */
function imprimirVenda(id){
  const v=_vens.find(x=>x.id===id);
  const w=window.open("","","width=300,height=600");
  w.document.write(`<body onload="window.print();window.close()">TOTAL R$ ${v.valor}</body>`);
}

/* ========= RENDER VENDAS ========= */
function renderVen(){
  listVen.innerHTML=_vens.map(v=>`
    <div>
      ${v.clientes?.nome} - R$ ${v.valor}
      <button onclick="imprimirVenda(${v.id})">ğŸ–¨ï¸</button>
    </div>`).join("");
}
</script>

</body>

</html>
  `);

  w.document.close();
}


    
</script>



function changeTab(id, btn) {
    document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    document.querySelectorAll('#sidebar button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

<script>
async function loadAll() {
  const [{ data: c }, { data: p }, { data: v }, { data: o }, { data: r }] =
    await Promise.all([
      db.from('clientes').select('*').order('nome'),
      db.from('produtos').select('*').order('nome'),
      db.from('vendas')
        .select('*, clientes(nome), produtos(nome)')
        .order('data', { ascending: false }),
      db.from('ordens_servico').select('*, clientes(nome)').order('id', { ascending: false }),
      db.from('orcamentos').select('*, clientes(nome)').order('id', { ascending: false })
    ]);

  _clis = c || [];
  _prods = p || [];
  _vens = v || [];
  _oss = o || [];
  _orcs = r || [];

  refreshSelects();
  renderCli();
  renderEst();
  renderVen();
  renderOS();
  renderOrc();
  updateDash();
}
</script>


function refreshSelects() {
    const cliOptions = _clis.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
    ['vCliSelect', 'osCliSelect', 'orcCliSelect'].forEach(id => document.getElementById(id).innerHTML = cliOptions);
    document.getElementById('vProdSelect').innerHTML = _prods.map(p => `<option value="${p.id}">${p.nome} (Estoque: ${p.q_id || p.qnt || 0})</option>`).join('');
}

// DASHBOARD CALCULATIONS


    
function updateDash() {
    let totalHoje = 0;
    let lucroHoje = 0;
    let totalMes = 0;
    let lucroMes = 0;

    const hoje = new Date();
    const dia = hoje.getDate();
    const mes = hoje.getMonth();
    const ano = hoje.getFullYear();

    _vens.forEach(v => {
        if (!v.data) return;

        const d = new Date(v.data);

        // ğŸ”¹ HOJE
        if (
            d.getDate() === dia &&
            d.getMonth() === mes &&
            d.getFullYear() === ano
        ) {
            totalHoje += Number(v.valor || 0);
            lucroHoje += Number(v.lucro_total || 0);
        }

        // ğŸ”¹ MÃŠS ATUAL
        if (
            d.getMonth() === mes &&
            d.getFullYear() === ano
        ) {
            totalMes += Number(v.valor || 0);
            lucroMes += Number(v.lucro_total || 0);
        }
    });

    const criticos = _prods.filter(p =>
        (p.q_id || p.qnt || 0) <= (p.estoque_minimo || 0)
    ).length;

    document.getElementById('vDia').innerText = `R$ ${totalHoje.toFixed(2)}`;
    document.getElementById('lDia').innerText = `R$ ${lucroHoje.toFixed(2)}`;
    document.getElementById('vMes').innerText = `R$ ${totalMes.toFixed(2)}`;
    document.getElementById('lMes').innerText = `R$ ${lucroMes.toFixed(2)}`;
    document.getElementById('qtdCrit').innerText = `${criticos} Itens`;

    renderChart();
}





function renderChart() {
    if (!_vens.length) return;

    const ctx = document.getElementById('chartDiario').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    const ultimasVendas = _vens.slice(0, 7).reverse();

    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ultimasVendas.map(v =>
                new Date(v.data).toLocaleDateString("pt-BR")
            ),
            datasets: [{
                label: 'Vendas Recentes',
                data: ultimasVendas.map(v => Number(v.valor || 0)),
                borderColor: '#0aff9d',
                backgroundColor: 'rgba(10, 255, 157, 0.1)',
                tension: 0.3,
                fill: true
            }]
        }
    });
}




// VENDAS LOGIC
function updateVendaPrice() {
    const p = _prods.find(x => x.id == document.getElementById('vProdSelect').value);
    const q = document.getElementById('vQtd').value;
    if(p) document.getElementById('vTotalLabel').innerText = `R$ ${(p.preco_revenda * q).toFixed(2)}`;
}

async function doVenda() {
    const p = _prods.find(x => x.id == document.getElementById('vProdSelect').value);
    if (!p) return alert("Produto invÃ¡lido");

    const q = Number(document.getElementById('vQtd').value);
    if (q <= 0) return alert("Quantidade invÃ¡lida");

    const tipoPagamento = document.getElementById('vTipoPagamento').value;
    if (!tipoPagamento) return alert("Selecione a forma de pagamento");

    const estoqueAtual = (p.q_id || p.qnt || 0);
    if (estoqueAtual < q) return alert("Estoque insuficiente!");

    const valorTotal = p.preco_revenda * q;
    const lucro = valorTotal - (p.preco_custo * q);

    await db.from('vendas').insert({
        cliente_id: document.getElementById('vCliSelect').value,
        produto_id: p.id,
        quantidade: q,
        valor: valorTotal,
        lucro_total: lucro,
        tipo_pagamento: tipoPagamento,
        data: new Date().toISOString()
    });

    await db.from('produtos')
      .update({ q_id: estoqueAtual - q, qnt: estoqueAtual - q })
      .eq('id', p.id);

    loadAll();
}

function imprimirVenda(id) {
  const v = _vens.find(x => x.id === id);
  if (!v) return alert("Venda nÃ£o encontrada");

  const w = window.open("", "_blank", "width=300,height=600");

  w.document.write(`
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cupom NÃ£o Fiscal</title>
<style>
  @page {
    size: 80mm auto;
    margin: 0;
  }
  body {
    width: 80mm;
    margin: 0;
    padding: 6px;
    font-family: monospace;
    font-size: 12px;
  }
  .center {
    text-align: center;
  }
  hr {
    border: none;
    border-top: 1px dashed #000;
    margin: 6px 0;
  }
</style>
</head>

<body onload="window.print(); window.close();">

<div class="center">
  <strong>SISTEMA HX</strong><br>
  CUPOM NÃƒO FISCAL
</div>

<hr>

Cliente: ${v.clientes?.nome || "NÃ£o informado"}<br>
Produto: ${v.produtos?.nome || "-"}<br>
Qtd: ${v.quantidade}<br>
Pagamento: ${v.tipo_pagamento || "N/I"}<br>

<hr>

<strong>TOTAL: R$ ${Number(v.valor).toFixed(2)}</strong><br>
Data: ${new Date(v.data).toLocaleString("pt-BR")}

<hr>

<div class="center">
  Obrigado pela preferÃªncia!
</div>

</body>
</html>
  `);

  w.document.close();
}



        
// GENERAL ACTIONS: RENDER, EDIT, DELETE
async function delItem(tab, id) {
    if(confirm("Deseja realmente excluir este registro?")) {
        await db.from(tab).delete().eq('id', id);
        loadAll();
    }
}

function renderVen() {
  const sNome = document.getElementById('sVenNome')?.value?.toLowerCase() || "";
  const sData = document.getElementById('sVenData')?.value || "";

  document.getElementById('listVen').innerHTML = _vens
    .filter(v =>
      (v.clientes?.nome?.toLowerCase().includes(sNome)) &&
      (sData ? v.data.startsWith(sData) : true)
    )
    .map(v => `
      <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>${v.clientes?.nome || "Cliente"}</strong><br>
          ${v.produtos?.nome || "-"} |
          Qtd: ${v.quantidade} |
          R$ ${Number(v.valor).toFixed(2)}<br>
          ğŸ’³ ${v.tipo_pagamento || "N/I"}
        </div>

        <div style="display:flex; gap:6px;">
          <button class="btn btn-add" onclick="imprimirVenda(${v.id})">ğŸ–¨ï¸</button>
          <button class="btn btn-edit" onclick="editarVenda(${v.id})">âœï¸</button>
          <button class="btn btn-del" onclick="delItem('vendas', ${v.id})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `)
    .join('');
}




// STOQUE RENDER WITH ALERT
function renderEst() {
    document.getElementById('listEst').innerHTML = _prods.map(p => {
        const estoque = (p.q_id || p.qnt || 0);
        const critico = estoque <= (p.estoque_minimo || 0);
        return `
        <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; ${critico ? 'color:var(--hx-danger)' : ''}">
            <span>${p.nome} | Estoque: <strong>${estoque}</strong> ${critico ? '<span class="critical">âš ï¸ BAIXO</span>' : ''}</span>
            <div>
                <button class="btn btn-edit" onclick="editProd(${p.id})">âœï¸</button>
                <button class="btn btn-del" onclick="delItem('produtos', ${p.id})">ğŸ—‘ï¸</button>
            </div>
        </div>`;
    }).join('');
}

async function editProd(id) {
    const p = _prods.find(x => x.id === id);
    const novaQtd = prompt(`Nova quantidade para ${p.nome}:`, (p.q_id || p.qnt || 0));
    if(novaQtd !== null) {
        await db.from('produtos').update({ q_id: Number(novaQtd), qnt: Number(novaQtd) }).eq('id', id);
        loadAll();
    }
}

function renderCli() {
    const s = document.getElementById('sCli').value.toLowerCase();
    document.getElementById('listCli').innerHTML = _clis.filter(c => c.nome.toLowerCase().includes(s)).map(c => `
        <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
            <span>${c.nome} - ${c.telefone || 'Sem fone'}</span>
            <div>
                <button class="btn btn-del" onclick="delItem('clientes', ${c.id})">ğŸ—‘ï¸</button>
            </div>
        </div>
    `).join('');
}

// OS AND ORC
async function saveOS() {
    await db.from('ordens_servico').insert({
        cliente_id: document.getElementById('osCliSelect').value,
        descricao: document.getElementById('osDesc').value,
        status: 'Aberta'
    });
    document.getElementById('osDesc').value = "";
    loadAll();
}

function renderOS() {
    document.getElementById('listOS').innerHTML = _oss.map(o => `
        <div class="card">
            <div style="display:flex; justify-content:space-between">
                <strong>OS #${o.id} - ${o.clientes?.nome}</strong>
                <button class="btn btn-del" onclick="delItem('ordens_servico', ${o.id})">ğŸ—‘ï¸</button>
            </div>
            <p>${o.descricao}</p>
        </div>
    `).join('');
}


async function editarVenda(id) {
  const v = _vens.find(x => x.id === id);
  if (!v) return alert("Venda nÃ£o encontrada");

  const novaQtd = prompt("Quantidade:", v.quantidade);
  if (novaQtd === null || isNaN(novaQtd) || Number(novaQtd) <= 0) {
    return alert("Quantidade invÃ¡lida");
  }

  const novoValor = prompt("Valor total:", v.valor);
  if (novoValor === null || isNaN(novoValor) || Number(novoValor) < 0) {
    return alert("Valor invÃ¡lido");
  }

  const novoTipo = prompt(
    "Forma de pagamento (Pix / Dinheiro / CartÃ£o):",
    v.tipo_pagamento || "Pix"
  );
  if (!novoTipo) return;

  // ğŸ”’ VALIDAÃ‡ÃƒO DO TIPO DE PAGAMENTO (AQUI ğŸ‘‡)
  const tipoValido = ["Pix", "Dinheiro", "CartÃ£o"];
  if (!tipoValido.includes(novoTipo)) {
    return alert("Use apenas: Pix, Dinheiro ou CartÃ£o");
  }

  // ğŸ’¾ ATUALIZA NO BANCO
  await db.from('vendas').update({
    quantidade: Number(novaQtd),
    valor: Number(novoValor),
    tipo_pagamento: novoTipo
  }).eq('id', id);

  loadAll();
}
            
// ORCAMENTOS
async function saveOrc() {
    await db.from('orcamentos').insert({
        cliente_id: document.getElementById('orcCliSelect').value,
        descricao: document.getElementById('orcDesc').value
    });
    document.getElementById('orcDesc').value = "";
    loadAll();
}

function renderOrc() {
    document.getElementById('listOrc').innerHTML = _orcs.map(r => `
        <div class="card">
            <div style="display:flex; justify-content:space-between">
                <strong>OrÃ§. #${r.id} - ${r.clientes?.nome}</strong>
                <button class="btn btn-del" onclick="delItem('orcamentos', ${r.id})">ğŸ—‘ï¸</button>
            </div>
            <p>${r.descricao}</p>
        </div>
    `).join('');
}

window.onload = async () => {
  const { data } = await db.auth.getSession();
  if (data.session) {
    document.getElementById('loginOverlay').style.display = 'none';
    loadAll();
  }
};
</script>
</body>
</html>









