<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Sistema HX</title>

<!-- SUPABASE + CHART -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0d0d0d;--bg2:#151515;--card:#181818;
  --txt:#eee;--accent:#0aff9d
}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:var(--txt)}
header{padding:14px;background:#111;color:var(--accent);font-size:20px}
#sidebar{width:220px;position:fixed;top:0;bottom:0;background:var(--bg2);padding-top:60px}
#sidebar button{width:100%;padding:12px;background:none;border:none;color:var(--txt);text-align:left;cursor:pointer}
#sidebar button:hover{background:#222}
main{margin-left:230px;padding:20px}
.card{background:var(--card);padding:15px;border-radius:10px;margin-bottom:15px}
h2,h3{color:var(--accent)}
input,select,textarea{width:100%;padding:8px;border-radius:6px;border:none;margin-bottom:8px}
button{padding:8px 14px;border:none;border-radius:6px;background:var(--accent);cursor:pointer}
canvas{max-height:250px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay" style="
  position:fixed;
  inset:0;
  background:#000c;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="background:#111;padding:20px;border-radius:10px;width:320px">
    <h2 style="color:#0aff9d">Login HX</h2>

    <input id="loginEmail" placeholder="Email">
    <input id="loginPass" type="password" placeholder="Senha">

    <button onclick="login()">Entrar</button>

    <div id="loginMsg" style="margin-top:10px;color:#f66"></div>
  </div>
</div>
  
<header>
Sistema HX
<span id="userLabel" style="float:right"></span>
</header>

<div id="sidebar">
<button onclick="showSection('dashboardSec')">üìä Dashboard</button>
<button onclick="showSection('vendasSec')">üí∞ Vendas</button>
<button onclick="showSection('produtosSec')">üì¶ Estoque</button>
<button onclick="showSection('orcamentoSec')">üìù Or√ßamento</button>
<button onclick="showSection('osSec')">üõ† O.S</button>
</div>

<main>

<!-- ================= DASHBOARD ================= -->
<section id="dashboardSec">
<h2>Dashboard</h2>

<div class="card">
<select id="filtroMes"></select>
<input id="filtroAno" type="number">
<button onclick="aplicarFiltro()">Aplicar</button>
<button onclick="imprimirDashboard()">üñ® Imprimir</button>
</div>

<div class="card"><canvas id="grafLucroDiario"></canvas></div>
<div class="card"><canvas id="grafVendasDiarias"></canvas></div>
<div class="card"><h3>Estoque Cr√≠tico</h3><div id="estoqueCritico"></div></div>
</section>

<!-- ================= VENDAS ================= -->
<section id="vendasSec" style="display:none">
<h2>Vendas</h2>

<div class="card">
<select id="venProduto"></select>
<input id="venQtd" type="number" placeholder="Quantidade">
<input id="venValor" type="number" placeholder="Valor">
<button onclick="registrarVenda()">Salvar Venda</button>
</div>

<div id="listaVendas"></div>
</section>

<!-- ================= ESTOQUE ================= -->
<section id="produtosSec" style="display:none">
<h2>Estoque</h2>

<div class="card">
<input id="pNome" placeholder="Produto">
<input id="pQtd" type="number" placeholder="Qtd">
<input id="pMin" type="number" placeholder="M√≠nimo">
<button onclick="salvarProduto()">Salvar</button>
</div>

<div id="listaProdutos"></div>
</section>

<!-- ================= OR√áAMENTO ================= -->
<section id="orcamentoSec" style="display:none">
<h2>Or√ßamento</h2>
<textarea id="orcDesc"></textarea>
<button onclick="salvarOrcamento()">Salvar</button>
<button onclick="imprimirOrcamento()">üñ® Imprimir</button>
</section>

<!-- ================= OS ================= -->
<section id="osSec" style="display:none">
<h2>Ordem de Servi√ßo</h2>
<textarea id="osDesc"></textarea>
<select id="osStatus">
<option>Aberta</option><option>Em andamento</option><option>Conclu√≠da</option>
</select>
<button onclick="salvarOS()">Salvar</button>
<button onclick="imprimirOS()">üñ® Imprimir</button>
</section>

</main>

<script>
/* SUPABASE */
const supabase = window.supabase.createClient(
 "https://axfccmezfofnqfsdurqb.supabase.co",
 "SUA_ANON_PUBLIC_KEY"
);

/* NAVEGA√á√ÉO */
function showSection(id){
 document.querySelectorAll("main section").forEach(s=>s.style.display="none");
 document.getElementById(id).style.display="block";
}

/* DASHBOARD / GR√ÅFICOS */
let c1,c2;
async function gerarGraficos(m,a){
 const {data:v}=await supabase.from("vendas").select("*");
 const l={},vd={};
 v?.forEach(x=>{
  const d=new Date(x.data);
  if(d.getMonth()!=m||d.getFullYear()!=a)return;
  const dia=d.getDate();
  l[dia]=(l[dia]||0)+Number(x.lucro||0);
  vd[dia]=(vd[dia]||0)+Number(x.valor||0);
 });
 if(c1)c1.destroy();
 c1=new Chart(grafLucroDiario,{type:"line",data:{labels:Object.keys(l),datasets:[{data:Object.values(l),borderColor:"#0aff9d"}]}});
 if(c2)c2.destroy();
 c2=new Chart(grafVendasDiarias,{type:"bar",data:{labels:Object.keys(vd),datasets:[{data:Object.values(vd),backgroundColor:"#0aff9d88"}]}});
}

/* ESTOQUE CR√çTICO */
async function carregarEstoqueCritico(){
 const {data:p}=await supabase.from("produtos").select("*");
 estoqueCritico.innerHTML="";
 p?.filter(x=>x.qtd<=x.min).forEach(x=>{
  estoqueCritico.innerHTML+=`<div>${x.nome} (${x.qtd})</div>`;
 });
}

/* ESTOQUE CRUD */
async function salvarProduto(){
 await supabase.from("produtos").insert({nome:pNome.value,qtd:pQtd.value,min:pMin.value});
}

/* VENDAS + BAIXA ESTOQUE */
async function registrarVenda(){
 await supabase.from("vendas").insert({
  produto:venProduto.value,
  qtd:venQtd.value,
  valor:venValor.value,
  data:new Date()
 });
 await supabase.rpc("baixa_estoque",{produto_id:venProduto.value,qtd:venQtd.value});
 imprimirRecibo();
}

/* IMPRESS√ïES */
function imprimirRecibo(){
 const w=window.open();
 w.document.write("<h2>RECIBO HX</h2><p>Venda registrada</p>");
 w.print();
}

function imprimirOrcamento(){
 const w=window.open();
 w.document.write("<h2>OR√áAMENTO HX</h2>"+orcDesc.value);
 w.print();
}

function imprimirOS(){
 const w=window.open();
 w.document.write("<h2>ORDEM DE SERVI√áO</h2>"+osDesc.value);
 w.print();
}

function imprimirDashboard(){
 const w=window.open();
 w.document.write("<h2>DASHBOARD HX</h2>");
 w.print();
}

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
 const d=new Date();
 filtroMes.innerHTML=[...Array(12)].map((_,i)=>`<option value="${i}">${i+1}</option>`).join("");
 filtroMes.value=d.getMonth();
 filtroAno.value=d.getFullYear();
 showSection("dashboardSec");
 gerarGraficos(d.getMonth(),d.getFullYear());
 carregarEstoqueCritico();
});
</script>

</body>
</html>

