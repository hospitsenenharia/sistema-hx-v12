<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Sistema HX ‚Äî Administra√ß√£o Completa</title>

  <!-- Chart.js ‚Äî Gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>

  <!-- Supabase 2.x (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    /* ============================================================
       üîß CONFIGURA√á√ÉO DO SUPABASE
    ============================================================ */
    const { createClient } = supabase;

    const supabaseClient = createClient(
      "https://axfccmezfofnqfsdurqb.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4ZmNjbWV6Zm9mbnFmc2R1cnFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzA1NDMsImV4cCI6MjA4MDY0NjU0M30.woGp6hBgiEa41opQxyxqqMULlDKMXm9T83bhJ7UEmb8"
    );

    // Torna global
    window.supabase = supabaseClient;

    function carregarUsuario() {
      supabase.auth.getUser().then(({ data }) => {
        if (data?.user) {
          userLabel.innerText = data.user.email;
        }
      });
    }

    async function login() {
      const email = loginEmail.value.trim();
      const senha = loginPass.value.trim();

      if (!email || !senha) {
        loginMsg.innerText = "Digite email e senha!";
        return;
      }

      const { error } = await supabase.auth.signInWithPassword({
        email,
        password: senha
      });

      if (error) {
        loginMsg.innerText = "Erro: " + error.message;
        return;
      }

      loginOverlay.style.display = "none";
      carregarUsuario();
      atualizarTudo();
    }
  </script>

  <style>
    :root {
      --hx-dark: #0d0d0d;
      --hx-dark2: #151515;
      --hx-dark3: #1f1f1f;
      --hx-accent: #0aff9d;
      --hx-text: #eaeaea;
      --hx-card: #181818;
    }
    #grafVendas {
    max-height: 220px !important;
    }
    body.light {
      --hx-dark: #f5f5f5;
      --hx-dark2: #ffffff;
      --hx-dark3: #e0e0e0;
      --hx-text: #111111;
      --hx-card: #ffffff;
    }

    body {
      margin: 0;
      background: var(--hx-dark);
      color: var(--hx-text);
      font-family: "Segoe UI", sans-serif;
    }

    #loginOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.88);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-card {
      background: #111;
      width: 340px;
      padding: 25px;
      border-radius: 12px;
      color: white;
      border: 1px solid var(--hx-accent);
      box-shadow: 0 0 20px rgba(0,255,150,0.3);
    }

    .login-card input {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      background: #222;
      border: 1px solid #444;
      border-radius: 8px;
      color: white;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border: none;
      border-radius: 8px;
      background: var(--hx-accent);
      color: black;
      font-weight: bold;
      cursor: pointer;
    }

    .login-msg {
      margin-top: 10px;
      color: #ff6363;
      text-align: center;
    }

    header {
      padding: 16px 20px;
      background: var(--hx-dark2);
      color: var(--hx-accent);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 22px;
      font-weight: bold;
      box-shadow: 0 2px 10px #000;
    }

    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      padding-top: 80px;
      width: 240px;
      height: 100vh;
      background: var(--hx-dark2);
    }

    #sidebar button {
      width: 100%;
      background: none;
      border: none;
      color: var(--hx-text);
      padding: 14px;
      font-size: 17px;
      text-align: left;
      cursor: pointer;
      transition: 0.25s;
    }

    #sidebar button:hover {
      background: var(--hx-dark3);
      padding-left: 20px;
    }

    .menu-active {
      background: var(--hx-accent) !important;
      color: black !important;
    }

    main {
      margin-left: 260px;
      padding: 22px;
    }

    .card {
      background: var(--hx-card);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px #000;
    }

    h2, h3 {
      color: var(--hx-accent);
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: var(--hx-dark3);
      color: var(--hx-text);
      margin-bottom: 12px;
    }

    .btn {
      background: var(--hx-accent);
      color: black;
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    .btn.secondary {
      background: #444;
      color: white;
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="loginOverlay">
    <div class="login-card">
      <h2 style="color:#0aff9d; text-align:center; margin-bottom:10px;">
        üîí Acesso ao Sistema HX
      </h2>

      <label>Email</label>
      <input id="loginEmail" type="email">

      <label>Senha</label>
      <input id="loginPass" type="password">

      <button class="login-btn" onclick="login()">Entrar</button>

      <div id="loginMsg" class="login-msg"></div>

      <div style="margin-top:12px; font-size:13px; text-align:center;">
        <a href="#" onclick="enviarRecuperacaoSenha(); return false;">Esqueci minha senha</a><br>
        <a href="#" onclick="cadastrarUsuario(); return false;">Criar novo usu√°rio</a>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <img src="https://i.imgur.com/8Tqj0MW.png" height="40">
    Sistema HX ‚Äî Painel Administrativo
    <span id="userLabel" style="margin-left:auto; color:#0aff9d;"></span>

    <button id="themeToggle" class="btn secondary" onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
  </header>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <button onclick="showSection('dashboardSec', this)" class="menu-active">üìä Dashboard</button>
    <button onclick="showSection('clientesSec', this)">üë§ Clientes</button>
    <button onclick="showSection('produtosSec', this)">üì¶ Estoque</button>
    <button onclick="showSection('vendasSec', this)">üíµ Vendas</button>
    <button onclick="showSection('osSec', this)">üõ† Ordem de Servi√ßo</button>
    <button onclick="showSection('orcamentoSec', this)">üìù Or√ßamentos</button>
    <button onclick="alterarSenha()" class="btn secondary" style="margin-top:20px;">Alterar senha</button>
    <button onclick="logout()" class="btn secondary" style="margin-top:10px;">Sair</button>
  </div>

  <!-- MAIN -->
  <main>
    <!-- DASHBOARD -->
    <section id="dashboardSec">
      <h2>üìä Dashboard Financeiro</h2>
    async function atualizarTudo() {
  await carregarClientes();
  await carregarProdutos();
  await carregarVendas();
  await carregarOS();
  await carregarOrcamentos();
  await carregarDashboard();
  await gerarGraficosDashboard();   // ‚¨ÖÔ∏è ADICIONE ESTA LINHA
}

      <div class="card">
        <h3>Resumo Geral</h3>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
          <div class="card" style="flex:1;">
            <h3>Faturamento Total</h3>
            <div id="fatTotal" style="font-size:28px; color:var(--hx-accent);">R$ 0,00</div>
          </div>

          <div class="card" style="flex:1;">
            <h3>Total de Vendas</h3>
            <div id="numVendas" style="font-size:28px; color:var(--hx-accent);">0</div>
          </div>

          <div class="card" style="flex:1;">
            <h3>Ordens de Servi√ßo</h3>
            <div id="numOS" style="font-size:28px; color:var(--hx-accent);">0</div>
          </div>
        </div>
      </div>

      <!-- NOVOS GR√ÅFICOS -->
''''''<!-- NOVOS GR√ÅFICOS -->
<div class="card">
  <h3>Vendas Di√°rias</h3>
  <canvas id="grafVendasDiarias" style="max-height: 250px;"></canvas>
</div>

<div class="card">
  <h3>Vendas Semanais</h3>
  <canvas id="grafVendasSemanal" height="100"></canvas>
</div>

<div class="card">
  <h3>Vendas Mensais</h3>
  <canvas id="grafVendasMensal" height="100"></canvas>
</div>

<div class="card">
  <h3>Vendas Anuais</h3>
  <canvas id="grafVendasAnual" height="100"></canvas>
</div>

<div class="card">
  <h3>Lucro Total por Dia</h3>
  <canvas id="grafLucro" height="100"></canvas>
</div>

<div class="card">
  <h3>Custo √ó Revenda √ó Lucro</h3>l
  <canvas id="grafCustoRevenda" height="100"></canvas>
</div>

<div class="card">
  <h3>Ranking dos Produtos Mais Vendidos</h3>
  <canvas id="grafRankingProdutos" height="100"></canvas>
</div>

<div class="card">
  <h3>Estoque Cr√≠tico</h3>
  <div id="estoqueCritico"></div>
</div>


    <!-- CLIENTES -->
    <section id="clientesSec" style="display:none;">
      <h2>üë§ Clientes</h2>

      <div class="card">
        <label>Nome</label>
        <input id="cliNome">

        <label>Telefone</label>
        <input id="cliTel">

        <label>CPF</label>
        <input id="cliCPF">

        <label>Endere√ßo</label>
        <input id="cliEnd">

        <button class="btn" onclick="salvarCliente()">Salvar Cliente</button>
      </div>

      <div class="card">
        <h3>Lista de Clientes</h3>
        <div id="listaClientes"></div>
      </div>
    </section>

    <!-- PRODUTOS -->
    <section id="produtosSec" style="display:none;">
      <h2>üì¶ Estoque</h2>

      <div class="card">
        <label>Nome</label>
        <input id="prodNome">

        <label>C√≥digo</label>
        <input id="prodCodigo">

        <label>Marca</label>
        <input id="prodMarca">

        <label>Modelo</label>
        <input id="prodModelo">

        <label>Pre√ßo de Custo</label>
        <input id="prodCusto" type="number" step="0.01" value="0">

        <label>Pre√ßo de Revenda</label>
        <input id="prodRevenda" type="number" step="0.01" value="0">

        <label>Quantidade</label>
        <input id="prodQtd" type="number" value="0">

        <label>Estoque M√≠nimo</label>
        <input id="prodMin" type="number" value="1">

        <button class="btn" onclick="salvarProduto()">Salvar Produto</button>
      </div>

      <div class="card">
        <h3>Lista de Produtos</h3>
        <div id="listaProdutos"></div>
      </div>
    </section>

    <!-- VENDAS -->
    <section id="vendasSec" style="display:none;">
      <h2>üíµ Registrar Venda</h2>

      <div class="card">
        <label>Cliente</label>
        <select id="venCliente"></select>

        <label>Produto</label>
        <select id="venProduto"></select>

        <label>Quantidade</label>
        <input id="venQtd" type="number" value="1">

        <label>Valor Pago (R$)</label>
        <input id="venValor" type="number" value="0">

        <button class="btn" onclick="registrarVenda()">Registrar Venda</button>
      </div>

      <div class="card">
        <h3>Lista de Vendas</h3>
        <div id="listaVendas"></div>
      </div>
    </section>

    <!-- ORDEM DE SERVI√áO -->
    <section id="osSec" style="display:none;">
      <h2>üõ† Ordens de Servi√ßo</h2>

      <div class="card">
        <label>Cliente</label>
        <select id="osCliente"></select>

        <label>Status</label>
        <select id="osStatus">
          <option value="Aberta">Aberta</option>
          <option value="Em andamento">Em andamento</option>
          <option value="Conclu√≠da">Conclu√≠da</option>
        </select>

        <label>Descri√ß√£o</label>
        <textarea id="osDesc"></textarea>

        <button class="btn" onclick="criarOS()">Criar OS</button>
      </div>

      <div class="card">
        <h3>Lista de OS</h3>
        <div id="listaOS"></div>
      </div>
    </section>

    <!-- OR√áAMENTOS -->
    <section id="orcamentoSec" style="display:none;">
      <h2>üìù Or√ßamentos</h2>

      <div class="card">
        <label>Cliente</label>
        <select id="orcCliente"></select>

        <label>Descri√ß√£o</label>
        <textarea id="orcDesc"></textarea>

        <button class="btn" onclick="criarOrcamento()">Criar Or√ßamento</button>
      </div>

      <div class="card">
        <h3>Lista de Or√ßamentos</h3>
        <div id="listaOrcamentos"></div>
      </div>
    </section>
  </main>

  <!-- SCRIPTS GERAIS -->
  <script>
    function toggleTheme() {
      document.body.classList.toggle("light");
      if (document.body.classList.contains("light")) {
        localStorage.setItem("hxTheme", "light");
      } else {
        localStorage.removeItem("hxTheme");
      }
    }

    function showSection(secId, btn) {
      document.querySelectorAll("main section").forEach(s => s.style.display = "none");
      document.getElementById(secId).style.display = "block";

      document.querySelectorAll("#sidebar button").forEach(b => b.classList.remove("menu-active"));
      if (btn) btn.classList.add("menu-active");
    }

    async function logout() {
      await supabase.auth.signOut();
      loginOverlay.style.display = "flex";
      userLabel.innerText = "";
    }

    async function enviarRecuperacaoSenha() {
      const email = loginEmail.value.trim();
      if (!email) return alert("Digite seu email para recuperar a senha.");

      const { error } = await supabase.auth.resetPasswordForEmail(email);
      if (error) alert("Erro: " + error.message);
      else alert("Email de recupera√ß√£o enviado!");
    }

    async function cadastrarUsuario() {
      const email = prompt("Digite o email do novo usu√°rio:");
      const senha = prompt("Digite a senha do novo usu√°rio:");

      if (!email || !senha) return alert("Cadastro cancelado.");

      const { error } = await supabase.auth.signUp({ email, password: senha });
      if (error) alert("Erro: " + error.message);
      else alert("Usu√°rio cadastrado com sucesso!");
    }

    function alterarSenha() {
      alert("Fun√ß√£o de alterar senha ainda n√£o foi implementada.");
    }
  </script>

  <!-- CRUD CLIENTES / PRODUTOS / VENDAS / OS / OR√áAMENTOS -->
  <script>
    /* CLIENTES */
    async function salvarCliente() {
      const nome = cliNome.value.trim();
      const telefone = cliTel.value.trim();
      const cpf = cliCPF.value.trim();
      const endereco = cliEnd.value.trim();

      if (!nome) {
        alert("Informe o nome do cliente!");
        return;
      }

      const { error } = await supabase
        .from("clientes")
        .insert({ nome, telefone, cpf, endereco });

      if (error) {
        alert("Erro ao salvar cliente: " + error.message);
        return;
      }

      cliNome.value = "";
      cliTel.value = "";
      cliCPF.value = "";
      cliEnd.value = "";

      carregarClientes();
    }

    async function carregarClientes() {
      const { data, error } = await supabase
        .from("clientes")
        .select("*")
        .order("nome", { ascending: true });

      if (error) {
        console.error("Erro ao carregar clientes:", error);
        return;
      }

      listaClientes.innerHTML = "";
      venCliente.innerHTML = "";
      osCliente.innerHTML = "";
      orcCliente.innerHTML = "";

      data.forEach(cli => {
        listaClientes.innerHTML += `
          <div class="card">
            <b>${cli.nome}</b><br>
            Tel: ${cli.telefone || "-"}<br>
            CPF: ${cli.cpf || "-"}<br>
            Endere√ßo: ${cli.endereco || "-"}<br>
          </div>
        `;

        const opt = `<option value="${cli.id}">${cli.nome}</option>`;
        venCliente.innerHTML += opt;
        osCliente.innerHTML += opt;
        orcCliente.innerHTML += opt;
      });
    }

    /* PRODUTOS */
    async function salvarProduto() {
      const nome = prodNome.value.trim();
      const codigo = prodCodigo.value.trim();
      const marca = prodMarca.value.trim();
      const modelo = prodModelo.value.trim();
      const custo = Number(prodCusto.value || 0);
      const revenda = Number(prodRevenda.value || 0);
      const qtd = Number(prodQtd.value || 0);
      const minimo = Number(prodMin.value || 0);

      if (!nome) {
        alert("Informe o nome do produto!");
        return;
      }

      const { error } = await supabase
        .from("produtos")
        .insert({
          nome,
          codigo,
          marca,
          modelo,
          preco_custo: custo,
          preco_revenda: revenda,
          qtd,
          estoque_minimo: minimo
        });

      if (error) {
        alert("Erro ao salvar produto: " + error.message);
        return;
      }

      prodNome.value = "";
      prodCodigo.value = "";
      prodMarca.value = "";
      prodModelo.value = "";
      prodCusto.value = 0;
      prodRevenda.value = 0;
      prodQtd.value = 0;
      prodMin.value = 1;

      carregarProdutos();
    }

    async function carregarProdutos() {
      const { data, error } = await supabase
        .from("produtos")
        .select("*")
        .order("nome", { ascending: true });

      if (error) {
        console.log("Erro ao carregar produtos:", error);
        return;
      }

      listaProdutos.innerHTML = "";
      venProduto.innerHTML = "";

      data.forEach(p => {
        listaProdutos.innerHTML += `
          <div class="card">
            <b>${p.nome}</b><br>
            C√≥digo: ${p.codigo || "-"}<br>
            Marca: ${p.marca || "-"}<br>
            Modelo: ${p.modelo || "-"}<br>
            Custo: R$ ${(Number(p.preco_custo || 0)).toFixed(2)}<br>
            Revenda: R$ ${(Number(p.preco_revenda || 0)).toFixed(2)}<br>
            Qtd: ${p.qtd ?? 0}<br>
            M√≠nimo: ${p.estoque_minimo ?? 0}<br><br>
            <button class="btn" onclick="editarProduto(${p.id})">Editar</button>
            <button class="btn secondary" onclick="excluirProduto(${p.id})">Excluir</button>
          </div>
        `;

        venProduto.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
      });
    }

    function editarProduto(id) {
      supabase
        .from("produtos")
        .select("*")
        .eq("id", id)
        .single()
        .then(({ data }) => {
          if (!data) return alert("Produto n√£o encontrado.");

          alert(
            "Edi√ß√£o simples:\n" +
            "Por enquanto a edi√ß√£o via modal n√£o foi implementada.\n" +
            "Voc√™ pode excluir e cadastrar novamente."
          );
        });
    }

    async function excluirProduto(id) {
      if (!confirm("Excluir este produto?")) return;

      await supabase.from("produtos").delete().eq("id", id);
      carregarProdutos();
    }

    /* VENDAS */
    async function registrarVenda() {
      const cliente_id = venCliente.value;
      const produto_id = venProduto.value;
      const quantidade = Number(venQtd.value || 0);
      const valor = Number(venValor.value || 0);

      if (!cliente_id || !produto_id || quantidade <= 0 || valor <= 0) {
        alert("Preencha cliente, produto, quantidade e valor.");
        return;
      }

      const { data: prod, error: prodError } = await supabase
        .from("produtos")
        .select("*")
        .eq("id", produto_id)
        .single();

      if (prodError || !prod) {
        alert("Erro ao buscar produto.");
        return;
      }

      const custoUnit = Number(prod.preco_custo || 0);
      const revendaUnit = Number(prod.preco_revenda || 0);

      const custoTotal = custoUnit * quantidade;
      const lucroTotal = (revendaUnit - custoUnit) * quantidade;

      const { error } = await supabase.from("vendas").insert({
        cliente_id,
        produto_id,
        quantidade,
        valor,
        preco_revenda: revendaUnit,
        preco_custo: custoUnit,
        custo_total: custoTotal,
        lucro_total: lucroTotal,
        data: new Date().toISOString()
      });

      if (error) {
        alert("Erro ao registrar venda: " + error.message);
        return;
      }

      await supabase
        .from("produtos")
        .update({ qtd: (prod.qtd || 0) - quantidade })
        .eq("id", produto_id);

      alert("Venda registrada com sucesso!");
      atualizarTudo();
    }

    async function carregarVendas() {
      const { data, error } = await supabase
        .from("vendas")
        .select(`
          *,
          clientes (nome),
          produtos (nome)
        `)
        .order("data", { ascending: false });

      listaVendas.innerHTML = "";

      if (error) {
        listaVendas.innerHTML = "Erro ao carregar vendas.";
        return;
      }

      data.forEach(v => {
        listaVendas.innerHTML += `
          <div class="card">
            <b>Venda #${v.id}</b><br>
            Cliente: ${v.clientes?.nome || "-"}<br>
            Produto: ${v.produtos?.nome || "-"}<br><br>
            Quantidade: ${v.quantidade}<br>
            Pre√ßo Revenda: R$ ${(Number(v.preco_revenda || 0)).toFixed(2)}<br>
            Custo Unit√°rio: R$ ${(Number(v.preco_custo || 0)).toFixed(2)}<br>
            <b style="color:#0aff9d;">Lucro Total: R$ ${(Number(v.lucro_total || 0)).toFixed(2)}</b><br><br>
            Valor Pago: R$ ${(Number(v.valor || 0)).toFixed(2)}<br>
            Data: ${new Date(v.data).toLocaleString("pt-BR")}
          </div>
        `;
      });
    }

    /* ORDEM DE SERVI√áO */
    async function criarOS() {
      if (!osCliente.value || !osDesc.value.trim())
        return alert("Preencha cliente e descri√ß√£o!");

      await supabase.from("ordens_servico").insert({
        cliente_id: osCliente.value,
        descricao: osDesc.value,
        status: osStatus.value,
        data_abertura: new Date().toISOString()
      });

      osDesc.value = "";
      carregarOS();
    }

    async function carregarOS() {
      const { data } = await supabase
        .from("ordens_servico")
        .select(`
          id, descricao, status, data_abertura,
          clientes(nome)
        `)
        .order("id", { ascending: false });

      listaOS.innerHTML = "";

      data.forEach(os => {
        listaOS.innerHTML += `
          <div class="card" id="os-${os.id}">
            <b>OS #${os.id}</b><br>
            Cliente: ${os.clientes?.nome || "-"}<br>
            Status: ${os.status}<br>
            Abertura: ${new Date(os.data_abertura).toLocaleString("pt-BR")}<br><br>
            Descri√ß√£o:<br>${os.descricao}<br><br>
          </div>
        `;
      });
    }

    /* OR√áAMENTOS */
    async function criarOrcamento() {
      if (!orcCliente.value || !orcDesc.value.trim())
        return alert("Preencha cliente e descri√ß√£o!");

      await supabase.from("orcamentos").insert({
        cliente_id: orcCliente.value,
        descricao: orcDesc.value,
        data: new Date().toISOString()
      });

      orcDesc.value = "";
      carregarOrcamentos();
    }

    async function carregarOrcamentos() {
  const { data, error } = await supabase
    .from("orcamentos")   // ‚Üê ajuste depois se o nome n√£o for esse
    .select(`
      id, descricao, data,
      clientes(nome)
    `)
    .order("id", { ascending: false });

  listaOrcamentos.innerHTML = "";

  // üîß Prote√ß√£o contra NULL
  if (!data || data.length === 0) {
    listaOrcamentos.innerHTML = "Nenhum or√ßamento encontrado.";
    return;
  }

  data.forEach(orc => {

        listaOrcamentos.innerHTML += `
          <div class="card" id="orc-${orc.id}">
            <b>Or√ßamento #${orc.id}</b><br>
            Cliente: ${orc.clientes?.nome || "-"}<br>
            Data: ${new Date(orc.data).toLocaleString("pt-BR")}<br><br>
            ${orc.descricao}<br><br>
          </div>
        `;
      });
    }
  </script>

  <!-- DASHBOARD + GR√ÅFICOS -->
  <script>
    async function carregarDashboard() {
      const { data: vendas } = await supabase.from("vendas").select("valor,lucro_total");
      let total = 0;
      let lucroTotal = 0;

      vendas?.forEach(v => {
        total += Number(v.valor || 0);
        lucroTotal += Number(v.lucro_total || 0);
      });

      fatTotal.innerText = "R$ " + total.toFixed(2);

      if (!document.getElementById("lucroTotalBox")) {
        fatTotal.insertAdjacentHTML(
          "afterend",
          `<div id="lucroTotalBox" style="margin-top:6px;color:#0aff9d;font-size:18px;">
            Lucro Total: R$ ${lucroTotal.toFixed(2)}
          </div>`
        );
      } else {
        document.getElementById("lucroTotalBox").innerText =
          `Lucro Total: R$ ${lucroTotal.toFixed(2)}`;
      }

      const nv = await supabase.from("vendas").select("*", { count: "exact", head: true });
      numVendas.innerText = nv.count ?? 0;

      const nos = await supabase.from("ordens_servico").select("*", { count: "exact", head: true });
      numOS.innerText = nos.count ?? 0;

      const produtos = await supabase.from("produtos").select("*");
      let crit = "";
      produtos.data?.forEach(p => {
        if ((p.qtd || 0) <= (p.estoque_minimo || 0)) {
          crit += `‚ö†Ô∏è ${p.nome} ‚Äî Qtd: ${p.qtd}<br>`;
        }
      });

      estoqueCritico.innerHTML = crit || "Nenhum produto cr√≠tico.";
    }

    let chartDiarias, chartSemanal, chartMensal, chartAnual, chartLucro, chartCustoRevenda, chartRanking;

    async function gerarGraficosDashboard() {
      const { data: vendas, error } = await supabase
        .from("vendas")
        .select("data, valor, lucro_total, custo_total, preco_custo, preco_revenda, quantidade, produto_id, produtos(nome)");

      if (error || !vendas || vendas.length === 0) {
        console.log("Sem dados de vendas para gr√°ficos.");
        return;
      }

      // Destroy antigos
      [chartDiarias, chartSemanal, chartMensal, chartAnual, chartLucro, chartCustoRevenda, chartRanking]
        .forEach(ch => ch && ch.destroy());

      // 1) Vendas Di√°rias
      const dias = {};
      vendas.forEach(v => {
        const d = new Date(v.data).toLocaleDateString("pt-BR");
        dias[d] = (dias[d] || 0) + Number(v.valor || 0);
      });

      chartDiarias = new Chart(document.getElementById("grafVendasDiarias"), {
        type: "bar",
        data: {
          labels: Object.keys(dias),
          datasets: [{
            label: "Vendas Di√°rias",
            data: Object.values(dias)
          }]
        }
      });

      // 2) Vendas Semanais
      const semanas = {};
      vendas.forEach(v => {
        const d = new Date(v.data);
        const ano = d.getFullYear();
        const inicioAno = new Date(ano, 0, 1);
        const diff = Math.floor((d - inicioAno) / (1000 * 60 * 60 * 24));
        const semana = Math.ceil((diff + inicioAno.getDay() + 1) / 7);
        const chave = `Sem ${semana}/${ano}`;
        semanas[chave] = (semanas[chave] || 0) + Number(v.valor || 0);
      });

      chartSemanal = new Chart(document.getElementById("grafVendasSemanal"), {
        type: "line",
        data: {
          labels: Object.keys(semanas),
          datasets: [{
            label: "Vendas Semanais",
            data: Object.values(semanas)
          }]
        }
      });

      // 3) Vendas Mensais
      const meses = {};
      vendas.forEach(v => {
        const d = new Date(v.data);
        const chave = `${(d.getMonth() + 1).toString().padStart(2,"0")}/${d.getFullYear()}`;
        meses[chave] = (meses[chave] || 0) + Number(v.valor || 0);
      });

      chartMensal = new Chart(document.getElementById("grafVendasMensal"), {
        type: "line",
        data: {
          labels: Object.keys(meses),
          datasets: [{
            label: "Vendas Mensais",
            data: Object.values(meses)
          }]
        }
      });

      // 4) Vendas Anuais
      const anos = {};
      vendas.forEach(v => {
        const ano = new Date(v.data).getFullYear();
        anos[ano] = (anos[ano] || 0) + Number(v.valor || 0);
      });

      chartAnual = new Chart(document.getElementById("grafVendasAnual"), {
        type: "bar",
        data: {
          labels: Object.keys(anos),
          datasets: [{
            label: "Vendas Anuais",
            data: Object.values(anos)
          }]
        }
      });

      // 5) Lucro Total por Dia
      const lucroDias = {};
      vendas.forEach(v => {
        const d = new Date(v.data).toLocaleDateString("pt-BR");
        lucroDias[d] = (lucroDias[d] || 0) + Number(v.lucro_total || 0);
      });

      chartLucro = new Chart(document.getElementById("grafLucro"), {
        type: "line",
        data: {
          labels: Object.keys(lucroDias),
          datasets: [{
            label: "Lucro Total",
            data: Object.values(lucroDias)
          }]
        }
      });

      // 6) Custo √ó Revenda √ó Lucro
      const labelsVenda = vendas.map(v => "Venda " + v.produto_id);
      const custos = vendas.map(v => Number(v.preco_custo || 0));
      const revendas = vendas.map(v => Number(v.preco_revenda || 0));
      const lucros = vendas.map(v => Number(v.lucro_total || 0));

      chartCustoRevenda = new Chart(document.getElementById("grafCustoRevenda"), {
        type: "bar",
        data: {
          labels: labelsVenda,
          datasets: [
            { label: "Custo", data: custos },
            { label: "Revenda", data: revendas },
            { label: "Lucro", data: lucros }
          ]
        }
      });

      // 7) Ranking de produtos mais vendidos
      const ranking = {};
      const nomesProdutos = {};
      vendas.forEach(v => {
        ranking[v.produto_id] = (ranking[v.produto_id] || 0) + Number(v.quantidade || 0);
        if (v.produtos?.nome) {
          nomesProdutos[v.produto_id] = v.produtos.nome;
        }
      });

      const labelsRanking = Object.keys(ranking).map(id => nomesProdutos[id] || `Produto ${id}`);
      const valoresRanking = Object.values(ranking);

      chartRanking = new Chart(document.getElementById("grafRankingProdutos"), {
        type: "pie",
        data: {
          labels: labelsRanking,
          datasets: [{
            data: valoresRanking
          }]
        }
      });
    }
  </script>

  <!-- INICIALIZA√á√ÉO -->
  <script>
    async function atualizarTudo() {
      await carregarClientes();
      await carregarProdutos();
      await carregarVendas();
      await carregarOS();
      await carregarOrcamentos();
      await carregarDashboard();
      await gerarGraficosDashboard();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const theme = localStorage.getItem("hxTheme");
      if (theme === "light") document.body.classList.add("light");

      showSection("dashboardSec", document.querySelector("#sidebar button"));

      const sessionResp = await supabase.auth.getSession();
      const session = sessionResp.data.session;

      if (!session) {
        loginOverlay.style.display = "flex";
        return;
      }

      loginOverlay.style.display = "none";
      await carregarUsuario();
      atualizarTudo();
    });
  </script>
</body>
</html>
