<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Sistema HX â€” GestÃ£o Total</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
:root{
 --hx-dark:#0d0d0d;--hx-dark2:#151515;--hx-accent:#0aff9d;
 --hx-text:#eaeaea;--hx-danger:#ff5566
}
body{margin:0;background:var(--hx-dark);color:var(--hx-text);
font-family:Segoe UI,sans-serif;display:flex}
#sidebar{width:240px;background:var(--hx-dark2);height:100vh;
position:fixed;border-right:1px solid #333;display:flex;flex-direction:column}
#sidebar button{background:none;border:none;color:#fff;padding:15px;
text-align:left;cursor:pointer;border-left:3px solid transparent}
#sidebar button.active{background:#1f1f1f;color:var(--hx-accent);
border-left-color:var(--hx-accent)}
main{margin-left:240px;flex:1;padding:25px}
.card{background:#181818;padding:20px;border-radius:8px;
margin-bottom:20px;border:1px solid #333}
.grid-dash{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
input,select,textarea{width:100%;padding:10px;margin:8px 0;
background:#222;border:1px solid #444;color:#fff;border-radius:4px}
.btn{padding:10px;border:none;border-radius:4px;font-weight:bold;cursor:pointer}
.btn-add{background:var(--hx-accent);color:#000}
.btn-del{background:var(--hx-danger);color:#fff}
</style>
</head>

<body>

<nav id="sidebar">
 <div style="padding:20px;font-weight:bold;color:var(--hx-accent)">PAINEL HX</div>
 <button onclick="tab('dashTab',this)" class="active">ğŸ“Š Dashboard</button>
 <button onclick="tab('cliTab',this)">ğŸ‘¤ Clientes</button>
 <button onclick="tab('estTab',this)">ğŸ“¦ Estoque</button>
 <button onclick="tab('venTab',this)">ğŸ’µ Vendas</button>
</nav>

<main>

<!-- DASHBOARD -->
<section id="dashTab">
 <div class="grid-dash">
  <div class="card">Vendas Hoje<h3 id="vDia">R$ 0,00</h3></div>
  <div class="card">Lucro Hoje<h3 id="lDia">R$ 0,00</h3></div>
  <div class="card">Vendas MÃªs<h3 id="vMes">R$ 0,00</h3></div>
 </div>
 <div class="card"><canvas id="chart"></canvas></div>
</section>

<!-- CLIENTES -->
<section id="cliTab" style="display:none">
 <h2>Clientes</h2>
 <div class="card">
  <input id="cliNome" placeholder="Nome">
  <input id="cliTel" placeholder="Telefone">
  <button class="btn btn-add" onclick="addCliente()">Cadastrar</button>
 </div>
 <div id="listCli"></div>
</section>

<!-- ESTOQUE -->
<section id="estTab" style="display:none">
 <h2>Estoque</h2>
 <div id="listEst"></div>
</section>

<!-- PDV -->
<section id="venTab" style="display:none">
 <h2>PDV</h2>

 <div class="card">
  <select id="vCli"></select>
  <select id="vProd"></select>
  <input id="vQtd" type="number" value="1">
  <button class="btn btn-add" onclick="vender()">Finalizar Venda</button>
 </div>

 <div class="card">
  <input id="fNome" placeholder="Cliente">
  <input id="fData" type="date">
  <button class="btn" onclick="renderVendas()">Filtrar</button>
 </div>

 <div id="listVen"></div>
</section>

</main>

<script>
const { createClient } = supabase;
const db = createClient("https://axfccmezfofnqfsdurqb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4ZmNjbWV6Zm9mbnFmc2R1cnFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzA1NDMsImV4cCI6MjA4MDY0NjU0M30.woGp6hBgiEa41opQxyxqqMULlDKMXm9T83bhJ7UEmb8"
);
let chart;

async function load(){
 const [{data:cl},{data:pr},{data:ve}] = await Promise.all([
  db.from('clientes').select('*'),
  db.from('produtos').select('*'),
  db.from('vendas').select('*, clientes(nome), produtos(nome)').order('id',{ascending:false})
 ]);
 window.cl=cl||[]; window.pr=pr||[]; window.ve=ve||[];
 renderAll();
}

function renderAll(){
 // selects
 vCli.innerHTML=cl.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
 vProd.innerHTML=pr.map(p=>`<option value="${p.id}">${p.nome}</option>`).join('');

 // clientes
 listCli.innerHTML=cl.map(c=>`<div class="card">${c.nome}</div>`).join('');

 // estoque
 listEst.innerHTML=pr.map(p=>`
  <div class="card">${p.nome} â€” ${p.quantidade}</div>`).join('');

 dashboard();
 renderVendas();
}

function dashboard(){
 const hoje=new Date().toLocaleDateString('pt-BR');
 const mes=new Date().toISOString().slice(0,7);
 let vd=0,ld=0,vm=0,grp={};

 ve.forEach(v=>{
  const dBR=new Date(v.data).toLocaleDateString('pt-BR');
  const dISO=v.data.slice(0,7);
  if(dBR===hoje){vd+=v.valor;ld+=v.lucro_total}
  if(dISO===mes){vm+=v.valor;
   const dia=v.data.slice(8,10);
   grp[dia]=(grp[dia]||0)+v.valor}
 });

 vDia.innerText=`R$ ${vd.toFixed(2)}`;
 lDia.innerText=`R$ ${ld.toFixed(2)}`;
 vMes.innerText=`R$ ${vm.toFixed(2)}`;

 if(chart)chart.destroy();
 chart=new Chart(document.getElementById('chart'),{
  type:'line',
  data:{labels:Object.keys(grp),
  datasets:[{label:'Faturamento',data:Object.values(grp),borderColor:'#0aff9d'}]}
 });
}

async function addCliente(){
 await db.from('clientes').insert({
  nome:cliNome.value,telefone:cliTel.value});
 cliNome.value='';cliTel.value='';
 load();
}

async function vender(){
 const prod=pr.find(p=>p.id==vProd.value);
 const qtd=Number(vQtd.value);
 await db.from('vendas').insert({
  cliente_id:vCli.value,
  produto_id:prod.id,
  quantidade:qtd,
  valor:prod.preco_revenda*qtd,
  lucro_total:(prod.preco_revenda-prod.preco_custo)*qtd,
  data:new Date().toISOString()
 });
 load();
}

function renderVendas(){
 const n=fNome.value.toLowerCase();
 const d=fData.value;
 listVen.innerHTML=ve.filter(v=>
  (!n||v.clientes.nome.toLowerCase().includes(n)) &&
  (!d||v.data.startsWith(d))
 ).map(v=>`
  <div class="card">
   ${v.clientes.nome} â€” ${v.produtos.nome} â€” R$ ${v.valor}
   <button class="btn" onclick="recibo(${v.id})">ğŸ–¨ï¸</button>
   <button class="btn btn-del" onclick="del(${v.id})">ğŸ—‘ï¸</button>
  </div>`).join('');
}

function recibo(id){
 const v=ve.find(x=>x.id==id);
 const w=window.open('', '', 'width=300');
 w.document.write(`<body style="font-family:monospace;width:80mm">
 <h3>RECIBO</h3>
 Cliente:${v.clientes.nome}<br>
 Produto:${v.produtos.nome}<br>
 Valor:R$ ${v.valor}<br>
 ${new Date(v.data).toLocaleString()}
 <script>window.print()</script>
 </body>`);
}

async function del(id){
 if(confirm('Excluir?')){
  await db.from('vendas').delete().eq('id',id);
  load();
 }
}

function tab(id,b){
 document.querySelectorAll('section').forEach(s=>s.style.display='none');
 document.getElementById(id).style.display='block';
 document.querySelectorAll('#sidebar button').forEach(x=>x.classList.remove('active'));
 b.classList.add('active');
}

load();
</script>

</body>
</html>
