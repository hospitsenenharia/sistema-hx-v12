<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Sistema HX ‚Äî Administra√ß√£o Completa</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
/* ========================== TEMA DARK PREMIUM ========================== */
:root {
  --hx-dark: #0d0d0d;
  --hx-dark2: #151515;
  --hx-dark3: #1f1f1f;
  --hx-accent: #0aff9d;
  --hx-text: #eaeaea;
  --hx-card: #181818;
}

/* Tema claro usando mesmas vari√°veis */
body.light {
  --hx-dark: #f5f5f5;
  --hx-dark2: #ffffff;
  --hx-dark3: #e0e0e0;
  --hx-text: #111111;
  --hx-card: #ffffff;
}

body {
  margin: 0;
  background: var(--hx-dark);
  color: var(--hx-text);
  font-family: "Segoe UI", sans-serif;
}

/* LOGIN */
#loginOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.88);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.login-card {
  background: #111;
  width: 340px;
  padding: 25px;
  border-radius: 12px;
  color: white;
  border: 1px solid #0aff9d;
  box-shadow: 0 0 20px rgba(0,255,150,0.3);
}

.login-card input {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  background: #222;
  border: 1px solid #444;
  border-radius: 8px;
  color: white;
}

.login-btn {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border: none;
  border-radius: 8px;
  background: #0aff9d;
  color: black;
  font-weight: bold;
  cursor: pointer;
}

.login-msg { margin-top: 10px; color: #ff6363; text-align: center; }

/* HEADER */
header {
  padding: 16px 20px;
  background: var(--hx-dark2);
  color: var(--hx-accent);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 22px;
  font-weight: bold;
  box-shadow: 0 2px 10px #000;
}

/* SIDEBAR */
#sidebar {
  position: fixed;
  top: 0;
  left: 0;
  padding-top: 80px;
  width: 240px;
  height: 100vh;
  background: var(--hx-dark2);
}

#sidebar button {
  width: 100%;
  background: none;
  border: none;
  color: var(--hx-text);
  padding: 14px;
  font-size: 17px;
  text-align: left;
  cursor: pointer;
  transition: 0.25s;
}

#sidebar button:hover {
  background: var(--hx-dark3);
  padding-left: 20px;
}

.menu-active {
  background: var(--hx-accent) !important;
  color: black !important;
}

/* MAIN */
main { margin-left: 260px; padding: 22px; }

/* CARDS */
.card {
  background: var(--hx-card);
  padding: 18px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px #000;
}

h2, h3 { color: var(--hx-accent); }

input, select, textarea {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #333;
  background: var(--hx-dark3);
  color: var(--hx-text);
  margin-bottom: 12px;
}

.btn {
  background: var(--hx-accent);
  color: black;
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

.btn.secondary {
  background: #444;
  color: white;
}

/* Imagens */
.fotoPreviewBox {
  width: 150px;
  height: 150px;
  background: #111;
  border: 2px dashed #333;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
}

.fotoPreviewBox img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div class="login-card">
    <h2 style="color:#0aff9d; text-align:center; margin-bottom:10px;">üîí Acesso ao Sistema HX</h2>

    <label>Email</label>
    <input id="loginEmail" type="email">

    <label>Senha</label>
    <input id="loginPass" type="password">

    <button class="login-btn" onclick="login()">Entrar</button>

    <div id="loginMsg" class="login-msg"></div>

    <div style="margin-top:12px; font-size:13px; text-align:center;">
      <a href="#" onclick="enviarRecuperacaoSenha(); return false;">Esqueci minha senha</a><br>
      <a href="#" onclick="cadastrarUsuario(); return false;">Criar novo usu√°rio</a>
    </div>
  </div>
</div>

<header>
  <img src="https://i.imgur.com/8Tqj0MW.png" height="40">
  Sistema HX ‚Äî Painel Administrativo
  <span id="userLabel" style="margin-left:auto; color:#0aff9d;"></span>

  <button id="themeToggle" class="btn secondary" onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
</header>

<div id="sidebar">

  <button onclick="showSection('dashboardSec', this)" class="menu-active">üìä Dashboard</button>

  <button id="menuClientes" onclick="showSection('clientesSec', this)">üë§ Clientes</button>

  <button id="menuProdutos" onclick="showSection('produtosSec', this)">üì¶ Estoque</button>

  <button id="menuVendas" onclick="showSection('vendasSec', this)">üíµ Vendas</button>

  <button id="menuOS" onclick="showSection('osSec', this)">üõ† Ordem de Servi√ßo</button>

  <button id="menuOrc" onclick="showSection('orcamentoSec', this)">üìù Or√ßamentos</button>

  <button onclick="alterarSenha()" class="btn secondary" style="margin-top:20px;">Alterar senha</button>

  <button onclick="logout()" class="btn secondary" style="margin-top:10px;">Sair</button>

</div>

<main>

<!-- ======================= DASHBOARD ======================= -->
<section id="dashboardSec">
  <h2>üìä Dashboard Financeiro</h2>

  <div class="card">
    <h3>Resumo Geral</h3>
    <div style="display:flex; gap:20px; flex-wrap:wrap;">

      <div class="card" style="flex:1;">
        <h3>Faturamento Total</h3>
        <div id="fatTotal" style="font-size:28px; color:var(--hx-accent);">R$ 0,00</div>
      </div>

      <div class="card" style="flex:1;">
        <h3>Total de Vendas</h3>
        <div id="numVendas" style="font-size:28px; color:var(--hx-accent);">0</div>
      </div>

      <div class="card" style="flex:1;">
        <h3>Ordens de Servi√ßo</h3>
        <div id="numOS" style="font-size:28px; color:var(--hx-accent);">0</div>
      </div>

    </div>
  </div>

  <div class="card">
    <h3>Gr√°fico de Vendas</h3>
    <canvas id="grafVendas" height="120"></canvas>
  </div>

  <div class="card">
    <h3>Estoque Cr√≠tico</h3>
    <div id="estoqueCritico"></div>
  </div>
</section>

<!-- ======================= CLIENTES ======================= -->
<section id="clientesSec" style="display:none;">
  <h2>üë§ Clientes</h2>

  <div class="card">
    <label>Nome</label>
    <input id="cliNome">

    <label>Telefone</label>
    <input id="cliTel">

    <label>CPF</label>
    <input id="cliCPF">

    <label>Endere√ßo</label>
    <input id="cliEnd">

    <button class="btn" onclick="salvarCliente()">Salvar Cliente</button>
  </div>

  <div class="card">
    <h3>Lista de Clientes</h3>
    <div id="listaClientes"></div>
  </div>
</section>

<!-- ======================= PRODUTOS / ESTOQUE ======================= -->
<section id="produtosSec" style="display:none;">
  <h2>üì¶ Estoque</h2>

  <div class="card">
    <label>Foto do Produto</label>
    <div class="fotoPreviewBox" onclick="prodFoto.click()">
      <img id="fotoPreview" style="display:none;">
      <span id="fotoPlaceholder">Clique para enviar a foto</span>
    </div>

    <input type="file" id="prodFoto" accept="image/*" style="display:none;" onchange="previewFoto()">

    <label>Nome</label>
    <input id="prodNome">

    <label>C√≥digo</label>
    <input id="prodCodigo">

    <label>Marca</label>
    <input id="prodMarca">

    <label>Modelo</label>
    <input id="prodModelo">

    <label>Quantidade</label>
    <input type="number" id="prodQtd" value="0">

    <label>Estoque m√≠nimo</label>
    <input type="number" id="prodMin" value="1">

    <button class="btn" onclick="salvarProduto()">Salvar Produto</button>
  </div>

  <div class="card">
    <h3>Lista de Produtos</h3>
    <div id="listaProdutos"></div>
  </div>
</section>

<!-- ======================= VENDAS ======================= -->
<section id="vendasSec" style="display:none;">
  <h2>üíµ Registrar Venda</h2>

  <div class="card">
    <label>Cliente</label>
    <select id="venCliente"></select>

    <label>Produto</label>
    <select id="venProduto"></select>

    <label>Quantidade</label>
    <input type="number" id="venQtd" value="1">

    <label>Valor (R$)</label>
    <input type="number" id="venValor">

    <label>Forma de Pagamento</label>
    <select id="venPag">
      <option>PIX</option>
      <option>DINHEIRO</option>
      <option>CARTAO</option>
    </select>

    <button class="btn" onclick="registrarVenda()">Registrar Venda</button>
    <button class="btn secondary" onclick="exportarVendas()" style="margin-left:10px;">Exportar Vendas (CSV)</button>
  </div>

  <div class="card">
    <h3>Hist√≥rico de Vendas</h3>
    <div id="listaVendas"></div>
  </div>
</section>

<!-- ======================= ORDEM DE SERVI√áO ======================= -->
<section id="osSec" style="display:none;">
  <h2>üõ† Ordem de Servi√ßo</h2>

  <div class="card">
    <label>Cliente</label>
    <select id="osCliente"></select>

    <label>Descri√ß√£o</label>
    <textarea id="osDesc"></textarea>

    <label>Status</label>
    <select id="osStatus">
      <option>ABERTA</option>
      <option>ANDAMENTO</option>
      <option>CONCLUIDA</option>
    </select>

    <button class="btn" onclick="criarOS()">Criar OS</button>
  </div>

  <div class="card">
    <h3>Lista de OS</h3>
    <div id="listaOS"></div>
  </div>
</section>

<!-- ======================= OR√áAMENTOS ======================= -->
<section id="orcamentoSec" style="display:none;">
  <h2>üìù Or√ßamentos</h2>

  <div class="card">
    <label>Cliente</label>
    <select id="orcCliente"></select>

    <label>Descri√ß√£o</label>
    <textarea id="orcDesc"></textarea>

    <button class="btn" onclick="criarOrcamento()">Criar Or√ßamento</button>
  </div>

  <div class="card">
    <h3>Lista de Or√ßamentos</h3>
    <div id="listaOrcamentos"></div>
  </div>
</section>

<script>
/* ============================================================
   üîß CONFIG SUPABASE
============================================================ */
const { createClient } = window.supabase;

const supabase = createClient(
  "https://axfccmezfofnqfsdurqb.supabase.co",
  "sb_publishable_SRuOeWB2YqA-y_umfy2Nfw_Y0yxNUn9"
);

/* ============================================================
   üåó TEMA CLARO / ESCURO
============================================================ */
function toggleTheme() {
  document.body.classList.toggle("light");
  localStorage.setItem(
    "hxTheme",
    document.body.classList.contains("light") ? "light" : "dark"
  );
}

/* ============================================================
   üîê LOGIN
============================================================ */
window.login = async function () {
  const email = loginEmail.value.trim();
  const senha = loginPass.value.trim();

  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password: senha
  });

  if (error) {
    loginMsg.innerText = "‚ùå " + error.message;
    return;
  }

  loginMsg.innerText = "";
  loginOverlay.style.display = "none";

  await carregarUsuario();
  await atualizarTudo();
};

/* ============================================================
   üîê LOGOUT
============================================================ */
async function logout() {
  await supabase.auth.signOut();
  loginOverlay.style.display = "flex";
}

/* ============================================================
   üîê CADASTRO DE USU√ÅRIO
============================================================ */
async function cadastrarUsuario() {
  const email = prompt("Email do novo usu√°rio:");
  if (!email) return;

  const senha = prompt("Senha inicial:");
  if (!senha) return;

  const role = (prompt("Fun√ß√£o (admin/tecnico/vendedor):", "vendedor") || "vendedor").toLowerCase();

  const { data, error } = await supabase.auth.signUp({
    email,
    password: senha,
    options: { data: { role } }
  });

  if (error) alert("Erro: " + error.message);
  else alert("Usu√°rio criado com sucesso!");
}

/* ============================================================
   üîê ALTERAR SENHA
============================================================ */
async function alterarSenha() {
  const nova = prompt("Nova senha:");
  if (!nova) return;

  const { error } = await supabase.auth.updateUser({ password: nova });

  alert(error ? "Erro: " + error.message : "Senha alterada!");
}

/* ============================================================
   üîê RECUPERA√á√ÉO DE SENHA
============================================================ */
async function enviarRecuperacaoSenha() {
  const email = prompt("Digite seu email:");
  if (!email) return;

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.href
  });

  alert(error ? "Erro: " + error.message : "Se existir, o email foi enviado.");
}

/* ============================================================
   üîê CARREGAR USU√ÅRIO + PERMISS√ïES
============================================================ */
async function carregarUsuario() {
  const { data } = await supabase.auth.getUser();
  if (!data.user) return;

  userLabel.innerText = data.user.email;

  // Sempre mostrar todos os menus
  menuProdutos.style.display = "block";
  menuVendas.style.display = "block";
  menuOS.style.display = "block";
  menuOrc.style.display = "block";

  }


/* ============================================================
   üîÑ MANTER SESS√ÉO ATIVA
============================================================ */
supabase.auth.getSession().then(({ data }) => {
  if (data.session) {
    loginOverlay.style.display = "none";
    carregarUsuario();
    atualizarTudo();
  }
});

/* ============================================================
   üìå NAVEGA√á√ÉO ENTRE SE√á√ïES
============================================================ */
function showSection(id, btn) {
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";

  document.querySelectorAll("#sidebar button").forEach(b => {
    b.classList.remove("menu-active");
  });

  if (btn) btn.classList.add("menu-active");
}

/* ============================================================
   üì∑ FOTO DO PRODUTO
============================================================ */
function previewFoto() {
  const file = prodFoto.files[0];
  if (!file) return;

  fotoPreview.src = URL.createObjectURL(file);
  fotoPreview.style.display = "block";
  fotoPlaceholder.style.display = "none";
}

/* ============================================================
   üë§ CLIENTES
============================================================ */
async function salvarCliente() {
  if (!cliNome.value.trim()) {
    alert("Informe o nome!");
    return;
  }

  await supabase.from("clientes").insert({
    nome: cliNome.value,
    telefone: cliTel.value,
    cpf: cliCPF.value,
    endereco: cliEnd.value
  });

  cliNome.value = "";
  cliTel.value = "";
  cliCPF.value = "";
  cliEnd.value = "";

  carregarClientes();
}

async function carregarClientes() {
  const { data } = await supabase.from("clientes").select("*").order("nome");

  listaClientes.innerHTML = "";
  venCliente.innerHTML = "";
  osCliente.innerHTML = "";
  orcCliente.innerHTML = "";

  data.forEach(c => {
    listaClientes.innerHTML += `
      <div class="card">
        <b>${c.nome}</b><br>
        Tel: ${c.telefone || "-"}<br>
        CPF: ${c.cpf || "-"}
      </div>
    `;

    venCliente.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
    osCliente.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
    orcCliente.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
  });
}

/* ============================================================
   üì¶ PRODUTOS
============================================================ */
async function salvarProduto() {
  let foto_url = null;

  if (prodFoto.files.length > 0) {
    const file = prodFoto.files[0];
    const filename = `${Date.now()}_${file.name}`;
    const upload = await supabase.storage.from("fotos_produtos").upload(filename, file);

    if (!upload.error) {
      foto_url = supabase.storage.from("fotos_produtos").getPublicUrl(filename).data.publicUrl;
    }
  }

  await supabase.from("produtos").insert({
    nome: prodNome.value,
    codigo: prodCodigo.value,
    marca: prodMarca.value,
    modelo: prodModelo.value,
    qtd: Number(prodQtd.value),
    estoque_minimo: Number(prodMin.value),
    foto_url
  });

  prodNome.value = "";
  prodCodigo.value = "";
  prodMarca.value = "";
  prodModelo.value = "";
  prodQtd.value = 0;
  prodMin.value = 1;
  fotoPreview.style.display = "none";
  fotoPlaceholder.style.display = "block";

  carregarProdutos();
}

async function carregarProdutos() {
  const { data } = await supabase.from("produtos").select("*").order("nome");

  listaProdutos.innerHTML = "";
  venProduto.innerHTML = "";

  data.forEach(p => {
    listaProdutos.innerHTML += `
      <div class="card" style="display:flex; gap:16px;">
        ${p.foto_url ? `<img src="${p.foto_url}" style="width:90px; height:90px; border-radius:8px;">` : ""}
        <div>
          <b>${p.nome}</b><br>
          C√≥digo: ${p.codigo}<br>
          Marca: ${p.marca}<br>
          Qtd: ${p.qtd} ‚Äî Min: ${p.estoque_minimo}
        </div>
      </div>
    `;
    venProduto.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
  });
}

/* ============================================================
   üíµ VENDAS
============================================================ */
async function registrarVenda() {
  const cliente_id = venCliente.value;
  const produto_id = venProduto.value;
  const quantidade = Number(venQtd.value);
  const valor = Number(venValor.value);

  if (quantidade <= 0 || valor <= 0) {
    alert("Preencha quantidade e valor corretamente!");
    return;
  }

  await supabase.from("vendas").insert({
    cliente_id,
    produto_id,
    quantidade,
    valor
  });

  atualizarTudo();
}

async function carregarVendas() {
  const { data, error } = await supabase.from("vendas").select("*, clientes(nome), produtos(nome)").order("id", { ascending: false });

  if (error || !data) {
    listaVendas.innerHTML = "Erro ao carregar vendas.";
    return;
  }

  listaVendas.innerHTML = "";

  data.forEach(v => {
    listaVendas.innerHTML += `
      <div class="card">
        <b>Venda #${v.id}</b><br>
        Cliente: ${v.clientes?.nome || "-"}<br>
        Produto: ${v.produtos?.nome || "-"}<br>
        Quantidade: ${v.quantidade}<br>
        Valor: R$ ${Number(v.valor).toFixed(2)}<br>
        Data: ${new Date(v.created_at).toLocaleString("pt-BR")}
      </div>
    `;
  });
}

/* ============================================================
   üõ† ORDENS DE SERVI√áO
============================================================ */
async function criarOS() {
  await supabase.from("ordens_servico").insert({
    cliente_id: osCliente.value,
    descricao: osDesc.value,
    status: osStatus.value
  });

  osDesc.value = "";
  carregarOS();
}

async function carregarOS() {
  const { data } = await supabase
    .from("ordens_servico")
    .select("id, descricao, status, clientes(nome)")
    .order("id", { ascending: false });

  listaOS.innerHTML = "";

  data.forEach(o => {
    listaOS.innerHTML += `
      <div class="card os-card" data-os-id="${o.id}">
        <b>OS #${o.id}</b><br>
        Cliente: ${o.clientes.nome}<br>
        Status: ${o.status}<br><br>
        ${o.descricao}<br><br>
        <button class="btn secondary" onclick="imprimirOS(${o.id})">Imprimir OS</button>
      </div>
    `;
  });
}

function imprimirOS(id) {
  const card = document.querySelector(`[data-os-id="${id}"]`);
  if (!card) return;

  const win = window.open("", "_blank");
  win.document.write(`
    <html>
    <head>
      <title>OS #${id}</title>
      <style>
        body { font-family: Arial; padding:20px; }
        .box { border:1px solid #000; padding:15px; }
      </style>
    </head>
    <body>
      <h2>Ordem de Servi√ßo #${id}</h2>
      <div class="box">${card.innerHTML.replace(/<button.*<\/button>/, "")}</div>
    </body>
    </html>
  `);
  win.document.close();
  win.print();
}

/* ============================================================
   üìù OR√áAMENTOS
============================================================ */
async function criarOrcamento() {
  await supabase.from("orcamentos").insert({
    cliente_id: orcCliente.value,
    descricao: orcDesc.value
  });

  orcDesc.value = "";
  carregarOrcamentos();
}

async function carregarOrcamentos() {
  const { data } = await supabase
    .from("orcamentos")
    .select("id, descricao, clientes(nome)")
    .order("id", { ascending: false });

  listaOrcamentos.innerHTML = "";

  data.forEach(o => {
    listaOrcamentos.innerHTML += `
      <div class="card orc-card" data-orc-id="${o.id}">
        <b>Or√ßamento #${o.id}</b><br>
        Cliente: ${o.clientes.nome}<br><br>
        ${o.descricao}<br><br>
        <button class="btn secondary" onclick="imprimirOrcamento(${o.id})">
          Imprimir Or√ßamento
        </button>
      </div>
    `;
  });
}

/* ============================================================
   üîî NOTIFICA√á√ÉO DE ESTOQUE BAIXO
============================================================ */
async function verificarNotificacoesEstoque() {
  const { data } = await supabase.from("produtos").select("*");

  if (!data) return;

  const criticos = data.filter(p => p.qtd <= p.estoque_minimo);

  if (criticos.length > 0) {
    alert("‚ö†Ô∏è Aten√ß√£o! Existem " + criticos.length + " produtos com estoque baixo.");
  }
}

/* ============================================================
   üìä DASHBOARD
============================================================ */
async function carregarDashboard() {
  const vendas = await supabase.from("vendas").select("valor");

  let total = 0;
  vendas.data?.forEach(v => total += Number(v.valor));

  fatTotal.innerText = "R$ " + total.toFixed(2);

  const nv = await supabase.from("vendas").select("*", { count: "exact", head: true });
  numVendas.innerText = nv.count ?? 0;

  const nos = await supabase.from("ordens_servico").select("*", { count: "exact", head: true });
  numOS.innerText = nos.count ?? 0;

  const produtos = await supabase.from("produtos").select("*");

  let critHTML = "";
  produtos.data?.forEach(p => {
    if (p.qtd <= p.estoque_minimo) {
      critHTML += `‚ö†Ô∏è ${p.nome} ‚Äî Qtd: ${p.qtd}<br>`;
    }
  });

  estoqueCritico.innerHTML = critHTML || "Nenhum produto cr√≠tico.";
}

/* ============================================================ 
   üìù OR√áAMENTOS
============================================================ */
/* ============================================================ 
   üìù OR√áAMENTOS
============================================================ */
async function criarOrcamento() {
  await supabase.from("orcamentos").insert({
    cliente_id: orcCliente.value,
    descricao: orcDesc.value
  });

  orcDesc.value = "";
  carregarOrcamentos();
}

async function carregarOrcamentos() {
  const { data } = await supabase
    .from("orcamentos")
    .select("id, descricao, clientes(nome)")
    .order("id", { ascending: false });

  listaOrcamentos.innerHTML = "";

  data.forEach(o => {
    listaOrcamentos.innerHTML += `
      <div class="card orc-card" data-orc-id="${o.id}">
        <b>Or√ßamento #${o.id}</b><br>
        Cliente: ${o.clientes.nome}<br><br>
        ${o.descricao}<br><br>
        <button class="btn secondary" onclick="imprimirOrcamento(${o.id})">
          Imprimir Or√ßamento
        </button>
      </div>
    `;
  });
}


/* ============================================================ 
   üìà GR√ÅFICO DE VENDAS 
============================================================ */

/* ============================================================ 
   üìà GR√ÅFICO DE VENDAS USANDO A COLUNA "data"
============================================================ */

let graficoVendas = null;

async function gerarGraficoVendas() {

  // Busca as vendas e ordena pela coluna DATA
  const { data, error } = await supabase
    .from("vendas")
    .select("valor, data")
    .order("data", { ascending: true });

  if (error || !data) {
    console.error("Erro ao carregar dados do gr√°fico:", error);
    return;
  }

  // Agrupar valores por dia
  const dadosPorDia = {};

  data.forEach(v => {
    const dia = new Date(v.data).toLocaleDateString("pt-BR");

    if (!dadosPorDia[dia]) dadosPorDia[dia] = 0;

    dadosPorDia[dia] += Number(v.valor);
  });

  const labels = Object.keys(dadosPorDia);
  const valores = Object.values(dadosPorDia);

  // Se j√° existir gr√°fico, destruir para recriar
  if (graficoVendas) graficoVendas.destroy();

  const ctx = document.getElementById("grafVendas").getContext("2d");

  graficoVendas = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Vendas (R$)",
        data: valores,
        borderWidth: 3,
        tension: 0.3,
        borderColor: "#0aff9d",
        backgroundColor: "rgba(0,255,150,0.25)",
        pointBackgroundColor: "#0aff9d",
        pointRadius: 5
      }]
    },
    options: {
      plugins: {
        legend: { labels: { color: "white" } }
      },
      scales: {
        x: { ticks: { color: "white" } },
        y: { ticks: { color: "white" } }
      }
    }
  });
}


/* ============================================================
   üìä DASHBOARD
============================================================ */
async function carregarDashboard() {

  // Soma total do faturamento
  const vendas = await supabase.from("vendas").select("valor");

  let total = 0;
  vendas.data?.forEach(v => total += Number(v.valor));

  fatTotal.innerText = "R$ " + total.toFixed(2);

  // Contagem de vendas
  const nv = await supabase.from("vendas").select("*", { count: "exact", head: true });
  numVendas.innerText = nv.count ?? 0;

  // Contagem de OS
  const nos = await supabase.from("ordens_servico").select("*", { count: "exact", head: true });
  numOS.innerText = nos.count ?? 0;

  // Estoque cr√≠tico
  const produtos = await supabase.from("produtos").select("*");

  let critHTML = "";
  produtos.data?.forEach(p => {
    if (p.qtd <= p.estoque_minimo) {
      critHTML += `‚ö†Ô∏è ${p.nome} ‚Äî Qtd: ${p.qtd}<br>`;
    }
  });

  estoqueCritico.innerHTML = critHTML || "Nenhum produto cr√≠tico.";
}



/* ============================================================ 
   üîÑ ATUALIZAR TUDO
============================================================ */
async function atualizarTudo() {
  carregarClientes();
  carregarProdutos();
  carregarVendas();
  carregarOS();
  carregarOrcamentos();
  carregarDashboard();
  verificarNotificacoesEstoque();
  gerarGraficoVendas();     // << ADICIONE ISSO TAMB√âM
}


/* ============================================================ 
   üöÄ INICIAR O SISTEMA
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  const savedTheme = localStorage.getItem("hxTheme");
  if (savedTheme === "light") document.body.classList.add("light");

  showSection("dashboardSec", document.querySelector("#sidebar button"));
});
</script>
